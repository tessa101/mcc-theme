{% comment %}
MCC — Merch Product Detail Page (Mobile Drawer Base)
• Peek header untouched (no blocks inside)
• Wishlist/Favorites block rendered right under Buy buttons
• Reviews Badge block rendered at top of content (optional)
{% endcomment %}

<section id="product_merch_mobile"
  class="product-merch-mobile only-mobile"
  data-product-id="{{ product.id }}"
  data-section="{{ section.id }}"
  aria-label="Merch Product Page (Mobile)">

  <!-- === Vertical Gallery (outside drawer) === -->
  <div class="mm-gallery" data-mm-gallery>
    {% render 'mcc-merch-mobile-vertical-gallery', product: product, section: section %}
  </div>

  <!-- overlay: hidden by default; inserted later via JS -->
  <div class="mm-overlay" data-mm-overlay style="display:none;"></div>

  <!-- === Drawer (bottom sheet) === -->
 <div class="mm-drawer" data-mm-drawer data-warm-in="true" role="dialog" aria-modal="true">
    <div class="mm-handle" data-mm-handle></div>

    <!-- ONE scroll container for everything inside the drawer -->
    <div class="mm-sheet" data-mm-sheet>

      <!-- === Peek Header (title/price only) === -->
      <header class="mm-peek" data-mm-peek>
        {% render 'mcc-merch-mobile-peek', product: product %}
      </header>

      <!-- === Drawer Content === -->
      <div class="mm-content product-sections" data-mm-content>

        <!-- ===== Description ===== -->
        {% render 'mcc-merch-description', product: product %}

        <!-- ===== FORM (variant → qty → buy → wishlist) ===== -->
        <product-form class="product-form" data-type="add-to-cart-form">
  {%- form 'product', product, id: 'mcc-merch-form', novalidate: 'novalidate', data-product-form: '', class: 'mcc-merch-form' -%}

    <input type="hidden" name="id" value="{{ product.selected_or_first_available_variant.id }}">

    <section class="content-section" aria-label="Options">
      {% render 'mcc-variant-picker', product: product, section: section %}
    </section>

    <section class="content-section" aria-label="Quantity">
      {% render 'mcc-quantity-selector', product: product %}
    </section>

    <section class="content-section" aria-label="Purchase">
      {% render 'mcc-buy-buttons', product: product, show_dynamic_checkout: true %}
    </section>

    {%- for block in section.blocks -%}
      {%- if block.type == 'wishlist' -%}
        <section class="content-section mm-wishlist-row block-wishlist" {{ block.shopify_attributes }}>
          {%- assign a11y = block.settings.label | default: 'Add to favorites' -%}
          <div class="mm-wishlist-inner" style="margin-top:{{ block.settings.top_margin | default: 12 }}px">
            {%- if content_for_header contains 'wishlist-hero' -%}
              <div id="wishlisthero-product-page-button-container"
                   class="wh-button"
                   data-whish-btn
                   data-product-id="{{ product.id }}"
                   aria-label="{{ a11y }}"></div>
            {%- elsif content_for_header contains 'swym' -%}
              <button class="swym-button swym-add-to-wishlist block-wishlist"
                      data-swaction="addToWishlist"
                      data-product-id="{{ product.id }}"
                      aria-label="{{ a11y }}"></button>
            {%- else -%}
              <button class="mm-fave-btn block-wishlist" type="button" data-mm-fave aria-label="{{ a11y }}">
                <span class="mm-fave-icon" aria-hidden="true">♡</span>
                <span class="mm-fave-text">Add to favorites</span>
              </button>
            {%- endif -%}
          </div>
        </section>
      {%- endif -%}
    {%- endfor -%}

  {%- endform -%}
</product-form>

        

        <!-- ===== Details (accordion) ===== -->
        {% assign merch_details = product.metafields.custom.merch_details %}
        {% if merch_details != blank %}
        <section class="coffee-accordion content-section" data-accordion data-acc="details">
          <header class="coffee-acc-header">
            <h2 class="coffee-acc-title">Details</h2>
            <button class="coffee-acc-trigger" type="button" aria-controls="acc-details-{{ section.id }}" aria-expanded="false">
              <span class="sr-only">Toggle Details</span>
            </button>
          </header>
          <div id="acc-details-{{ section.id }}" class="coffee-acc-panel" data-acc-panel>
            <div class="description-content rte">{{ merch_details | metafield_tag }}</div>
          </div>
        </section>
        {% endif %}

        <!-- ===== Reviews (accordion) ===== -->
        <section class="coffee-accordion content-section" data-accordion data-acc="reviews">
          <header class="coffee-acc-header">
            <h2 class="coffee-acc-title coffee-reviews-title">Recent reviews</h2>
            <button class="coffee-acc-trigger" type="button" aria-controls="acc-reviews-{{ section.id }}" aria-expanded="false">
              <span class="sr-only">Toggle Recent reviews</span>
            </button>
          </header>
          <div id="acc-reviews-{{ section.id }}" class="coffee-acc-panel" data-acc-panel>
            <div class="pdp-module pdp-reviews" id="reviews" data-mcc-reviews>
              {%- comment -%}
              <div id="judgeme_product_reviews"
                   class="jdgm-widget jdgm-review-widget"
                   data-product-title="{{ product.title | escape }}"
                   data-id="{{ product.id }}">
                {{ product.metafields.judgeme.widget }}
              </div>
              {%- endcomment -%}
              <p class="mcc-reviews-placeholder">Reviews coming soon.</p>
            </div>
          </div>
        </section>

        <!-- ===== Recommended ===== -->
        <section class="content-section coffee-recs" id="recommendations">
          {% assign beans_col    = collections['beans'] %}
          {% assign merch_col    = collections['merch'] %}
          {% assign coldbrew_col = collections['cold-brew'] | default: collections['coldbrew'] %}
          {% assign product_col_handles = product.collections | map: 'handle' | join: ',' | downcase %}

          {% assign target_collection = nil %}
          {% if product_col_handles contains 'beans' and beans_col and beans_col.products_count > 1 %}
            {% assign target_collection = beans_col %}
          {% elsif product_col_handles contains 'merch' and merch_col and merch_col.products_count > 1 %}
            {% assign target_collection = merch_col %}
          {% elsif product_col_handles contains 'cold-brew' and coldbrew_col and coldbrew_col.products_count > 1 %}
            {% assign target_collection = coldbrew_col %}
          {% endif %}
          {% if target_collection == nil %}
            {% if beans_col and beans_col.products_count > 1 %}
              {% assign target_collection = beans_col %}
            {% elsif merch_col and merch_col.products_count > 1 %}
              {% assign target_collection = merch_col %}
            {% elsif coldbrew_col and coldbrew_col.products_count > 1 %}
              {% assign target_collection = coldbrew_col %}
            {% endif %}
          {% endif %}
          {% if target_collection and target_collection.products %}
            {% assign rec_products = target_collection.products %}
          {% elsif collections['all'] and collections['all'].products_count > 1 %}
            {% assign rec_products = collections['all'].products %}
          {% endif %}
          {% if rec_products != blank %}
            {% assign see_more = product.collections.first.url | default: '/collections/all' %}
            {% render 'mcc-recommended-products',
              product: product,
              products: rec_products,
              title: 'You might also like',
              limit: 6,
              see_more_url: see_more %}
          {% endif %}
        </section>

      </div><!-- /.mm-content -->
    </div><!-- /.mm-sheet -->
  </div><!-- /.mm-drawer -->
</section>

<style>
  /* Keep drag responsive and stop Safari oddities */
.mm-handle, [data-mm-peek] { touch-action: none; }       /* allow our custom drag */
.mm-sheet { touch-action: pan-y; overscroll-behavior: contain; } /* scroll content normally */

  /* Layering */
  #product_merch_mobile .mm-drawer{ z-index: 4000 !important; }

  /* Mobile-only footer hide */
  @media (max-width: 749px){
    body.template-product #shopify-section-footer,
    body.template-product [id^="shopify-section-footer"],
    body.template-product [id*="__footer"],
    body.template-product footer,
    body.template-product [role="contentinfo"]{ display: none !important; }
  }

  /* Announcement Bar lift for merch mobile template */
  @media (max-width: 749px){
    body.template-product-merch .announcement-bar{
      position: relative;
      z-index: 9999 !important;
    }
  }

  /* Reviews badge small tweaks */
  .product-merch-mobile .pdp-reviews-badge-wrap .jdgm-widget{ display:inline-block; }

  /* Wishlist fallback button styles */
  .product-merch-mobile .mm-wishlist-row { padding-top: .25rem; }
  .product-merch-mobile .mm-wishlist-inner { display:flex; }
  .product-merch-mobile .mm-fave-btn{
    display:inline-flex; gap:.5rem; align-items:center; justify-content:center;
    width:auto; min-height:44px; padding:.6rem .9rem;
    border-radius:999px; border:1px solid #ddd; background:#fff; font-size:16px;
  }
  .product-merch-mobile .mm-fave-btn.is-active{ border-color:#000; }
  .product-merch-mobile .mm-fave-icon{ transform: translateY(-1px); }
</style>

<script>
  // Safety net: if a different footer ID is used, hide it on mobile after load.
  document.addEventListener('DOMContentLoaded', function () {
    if (!window.matchMedia('(max-width: 749px)').matches) return;
    var footer = document.querySelector(
      'footer, [role="contentinfo"], [id^="shopify-section-footer"], [id*="__footer"]'
    );
    if (footer) footer.style.display = 'none';
  });
</script>

{{ 'mcc-merch-mobile.css' | asset_url | stylesheet_tag }}
<script src="{{ 'mcc-merch-mobile.js' | asset_url }}" defer></script>



<script>
  /* MCC merch — safety reset on load */
/*
(function () {
  var html = document.documentElement, body = document.body;
  html.classList.remove('mm-locked');
  body.classList.remove('mm-locked');
  body.style.position=''; body.style.top=''; body.style.left=''; body.style.right='';
  var d = document.querySelector('.mm-drawer');
  var ov = document.querySelector('[data-mm-overlay]');
  if (d) d.classList.remove('is-open');
  if (ov) ov.style.display = 'none';
})();*/
</script>



<script>
  /* Clear locks when leaving / bfcache events */
/*
(function () {
  function clearLocks() {
    var html = document.documentElement, body = document.body;
    html.classList.remove('mm-locked');
    body.classList.remove('mm-locked');
    body.style.position=''; body.style.top=''; body.style.left=''; body.style.right='';
  }
  window.addEventListener('pagehide', clearLocks);
  window.addEventListener('visibilitychange', function () {
    if (document.visibilityState === 'hidden') clearLocks();
  });
})();*/
</script>


<script>
/* Fallback heart toggle only (no-op if app handles UI) */
document.addEventListener('click', (e) => {
  const btn = e.target.closest('[data-mm-fave]');
  if (!btn) return;
  btn.classList.toggle('is-active');
});
</script>

{% schema %}
{
  "name": "Product — Merch (Mobile)",
  "settings": [],
  "blocks": [
    {
      "type": "wishlist",
      "name": "Wishlist / Favorites",
      "limit": 1,
      "settings": [
        { "type": "text",  "id": "label",      "label": "Accessible label", "default": "Add to favorites" },
        { "type": "range", "id": "top_margin", "label": "Top spacing (px)", "min": 0, "max": 40, "step": 4, "default": 12 }
      ]
    },
    {
      "type": "reviews_badge",
      "name": "Reviews badge (Judge.me)",
      "limit": 1,
      "settings": [
        { "type": "checkbox", "id": "show_label", "label": "Show link label", "default": false },
        { "type": "text", "id": "label_text", "label": "Label text", "default": "See all reviews" },
        { "type": "range", "id": "top_margin", "label": "Top spacing (px)", "min": 0, "max": 48, "step": 4, "default": 12 }
      ]
    }
  ],
  "presets": [{ "name": "Product — Merch (Mobile)" }]
}
{% endschema %}
