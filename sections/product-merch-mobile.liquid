{% comment %}
MCC — Merch Product Detail Page (Mobile Drawer Base)
• Peek header untouched (no blocks inside)
• Wishlist/Favorites block rendered right under Buy buttons
• Reviews Badge block rendered at top of content (optional)
{% endcomment %}

<section id="product_merch_mobile"
  class="product-merch-mobile only-mobile"
  data-product-id="{{ product.id }}"
  data-section="{{ section.id }}"
  aria-label="Merch Product Page (Mobile)">

  <!-- === Vertical Gallery (outside drawer) === -->
  <div class="mm-gallery" data-mm-gallery>
    {% render 'mcc-merch-mobile-vertical-gallery', product: product, section: section %}
  </div>

  <!-- overlay: hidden by default; inserted later via JS -->
  <div class="mm-overlay" data-mm-overlay style="display:none;"></div>

  <!-- === Drawer (bottom sheet) === -->
 <div class="mm-drawer" data-mm-drawer data-warm-in="true" role="dialog" aria-modal="true">
    <div class="mm-handle" data-mm-handle></div>

    <!-- ONE scroll container for everything inside the drawer -->
    <div class="mm-sheet" data-mm-sheet>

      <!-- === Peek Header (title/price only) === -->
      <header class="mm-peek" data-mm-peek>
        {% render 'mcc-merch-mobile-peek', product: product %}
      </header>

      <!-- === Drawer Content === -->
      <div class="mm-content product-sections" data-mm-content>

        <!-- ===== Description ===== -->
        {% render 'mcc-merch-description', product: product %}

        <!-- ===== FORM (variant → qty → buy → wishlist) ===== -->
        <product-form class="product-form" data-type="add-to-cart-form">
  {%- form 'product', product, id: 'mcc-merch-form', novalidate: 'novalidate', data-product-form: '', class: 'mcc-merch-form' -%}

    <input type="hidden" name="id" value="{{ product.selected_or_first_available_variant.id }}">

    <section class="content-section" aria-label="Options">
      {% render 'mcc-variant-picker', product: product, section: section %}
    </section>

    <section class="content-section" aria-label="Quantity">
      {% render 'mcc-quantity-selector', product: product %}
    </section>

    <section class="content-section" aria-label="Purchase">
      {% render 'mcc-buy-buttons', product: product, show_dynamic_checkout: true %}
    </section>

    {%- for block in section.blocks -%}
      {%- if block.type == 'wishlist' -%}
        <section class="content-section mm-wishlist-row block-wishlist" {{ block.shopify_attributes }}>
          {%- assign a11y = block.settings.label | default: 'Add to favorites' -%}
          <div class="mm-wishlist-inner" style="margin-top:{{ block.settings.top_margin | default: 12 }}px">
            {%- if content_for_header contains 'wishlist-hero' -%}
              <div id="wishlisthero-product-page-button-container"
                   class="wh-button"
                   data-whish-btn
                   data-product-id="{{ product.id }}"
                   aria-label="{{ a11y }}"></div>
            {%- elsif content_for_header contains 'swym' -%}
              <button class="swym-button swym-add-to-wishlist block-wishlist"
                      data-swaction="addToWishlist"
                      data-product-id="{{ product.id }}"
                      aria-label="{{ a11y }}"></button>
            {%- else -%}
              <button class="mm-fave-btn block-wishlist" type="button" data-mm-fave aria-label="{{ a11y }}">
                <span class="mm-fave-icon" aria-hidden="true">♡</span>
                <span class="mm-fave-text">Add to favorites</span>
              </button>
            {%- endif -%}
          </div>
        </section>
      {%- endif -%}
    {%- endfor -%}

  {%- endform -%}
</product-form>

        

        <!-- ===== Details (accordion) ===== -->
        {% assign merch_details = product.metafields.custom.merch_details %}
        {% if merch_details != blank %}
        <section class="coffee-accordion content-section" data-accordion data-acc="details">
          <header class="coffee-acc-header">
            <h2 class="coffee-acc-title">Details</h2>
            <button class="coffee-acc-trigger" type="button" aria-controls="acc-details-{{ section.id }}" aria-expanded="false">
              <span class="sr-only">Toggle Details</span>
            </button>
          </header>
          <div id="acc-details-{{ section.id }}" class="coffee-acc-panel" data-acc-panel>
            <div class="description-content rte">{{ merch_details | metafield_tag }}</div>
          </div>
        </section>
        {% endif %}

        <!-- ===== Reviews (accordion) ===== -->
        <section class="coffee-accordion content-section" data-accordion data-acc="reviews">
          <header class="coffee-acc-header">
            <h2 class="coffee-acc-title coffee-reviews-title">Recent reviews</h2>
            <button class="coffee-acc-trigger" type="button" aria-controls="acc-reviews-{{ section.id }}" aria-expanded="false">
              <span class="sr-only">Toggle Recent reviews</span>
            </button>
          </header>
          <div id="acc-reviews-{{ section.id }}" class="coffee-acc-panel" data-acc-panel>
            <div class="pdp-module pdp-reviews" id="reviews" data-mcc-reviews>
              {%- comment -%}
              <div id="judgeme_product_reviews"
                   class="jdgm-widget jdgm-review-widget"
                   data-product-title="{{ product.title | escape }}"
                   data-id="{{ product.id }}">
                {{ product.metafields.judgeme.widget }}
              </div>
              {%- endcomment -%}
              <p class="mcc-reviews-placeholder">Reviews coming soon.</p>
            </div>
          </div>
        </section>

        <!-- ===== Recommended ===== -->
        <section class="content-section coffee-recs" id="recommendations">
          {% assign beans_col    = collections['beans'] %}
          {% assign merch_col    = collections['merch'] %}
          {% assign coldbrew_col = collections['cold-brew'] | default: collections['coldbrew'] %}
          {% assign product_col_handles = product.collections | map: 'handle' | join: ',' | downcase %}

          {% assign target_collection = nil %}
          {% if product_col_handles contains 'beans' and beans_col and beans_col.products_count > 1 %}
            {% assign target_collection = beans_col %}
          {% elsif product_col_handles contains 'merch' and merch_col and merch_col.products_count > 1 %}
            {% assign target_collection = merch_col %}
          {% elsif product_col_handles contains 'cold-brew' and coldbrew_col and coldbrew_col.products_count > 1 %}
            {% assign target_collection = coldbrew_col %}
          {% endif %}
          {% if target_collection == nil %}
            {% if beans_col and beans_col.products_count > 1 %}
              {% assign target_collection = beans_col %}
            {% elsif merch_col and merch_col.products_count > 1 %}
              {% assign target_collection = merch_col %}
            {% elsif coldbrew_col and coldbrew_col.products_count > 1 %}
              {% assign target_collection = coldbrew_col %}
            {% endif %}
          {% endif %}
          {% if target_collection and target_collection.products %}
            {% assign rec_products = target_collection.products %}
          {% elsif collections['all'] and collections['all'].products_count > 1 %}
            {% assign rec_products = collections['all'].products %}
          {% endif %}
          {% if rec_products != blank %}
            {% assign see_more = product.collections.first.url | default: '/collections/all' %}
            {% render 'mcc-recommended-products',
              product: product,
              products: rec_products,
              title: 'You might also like',
              limit: 6,
              see_more_url: see_more %}
          {% endif %}
        </section>

        <!-- ===== Footer (moved inside drawer) ===== -->
        <section class="content-section mcc-footer-in-drawer" id="merch-mobile-footer-container">
          {%- comment -%} Footer will be moved here via JavaScript {%- endcomment -%}
        </section>

      </div><!-- /.mm-content -->
    </div><!-- /.mm-sheet -->
  </div><!-- /.mm-drawer -->
</section>

<style>
  /* Keep drag responsive and stop Safari oddities */
.mm-handle, [data-mm-peek] { touch-action: none; }       /* allow our custom drag */
.mm-sheet { touch-action: pan-y; overscroll-behavior: contain; } /* scroll content normally */

  /* Layering */
  #product_merch_mobile .mm-drawer{ z-index: 998 !important; } /* below announcement bar (999/9999), scrolls under it like header */

  /* Ensure footer inside drawer has proper z-index and doesn't interfere with gallery */
  @media (max-width: 749px){
    /* Footer inside drawer should be in normal flow, not above gallery */
    #product_merch_mobile .mm-content .mcc-landing-footer,
    #product_merch_mobile .mm-content [data-mcc-landing="footer"],
    #product_merch_mobile .mm-content section.mcc-landing-footer,
    #product_merch_mobile .mm-content .mcc-footer-in-drawer {
      z-index: auto !important;
      position: relative !important;
    }
    
    /* Footer wrapper inside drawer */
    #product_merch_mobile .mm-content .mcc-footer-wrapper {
      z-index: auto !important;
      position: relative !important;
    }
    
    /* Ensure gallery stays above footer and creates proper stacking context */
    #product_merch_mobile .mm-gallery {
      z-index: 1 !important;
      isolation: isolate !important; /* Create new stacking context */
    }
    
    /* Footer outside drawer should be hidden */
    body.template-product .mcc-landing-footer:not(#product_merch_mobile .mcc-landing-footer),
    body.template-product [data-mcc-landing="footer"]:not(#product_merch_mobile [data-mcc-landing="footer"]) {
      z-index: -999 !important;
      position: relative !important;
    }
  }

  /* Mobile-only footer hide - hide footer outside drawer, show inside drawer */
  @media (max-width: 749px){
    /* Hide footer that's outside the drawer (from footer-group) */
    body.template-product #shopify-section-footer-group,
    body.template-product [id*="footer-group"],
    body.template-product #shopify-section-footer,
    body.template-product [id^="shopify-section-footer"],
    body.template-product [id*="shopify-section-footer"]:not(#product_merch_mobile *),
    body.template-product [id*="__footer"]:not(#product_merch_mobile *),
    body.template-product footer:not(#product_merch_mobile footer),
    body.template-product [role="contentinfo"]:not(#product_merch_mobile [role="contentinfo"]),
    /* Hide mcc-landing-footer that's outside the drawer */
    body.template-product .mcc-landing-footer:not(#product_merch_mobile .mcc-landing-footer),
    body.template-product section.mcc-landing-footer:not(#product_merch_mobile section.mcc-landing-footer),
    body.template-product [data-mcc-landing="footer"]:not(#product_merch_mobile [data-mcc-landing="footer"]),
    /* Hide parent sections containing footer (outside drawer) */
    body.template-product [id*="shopify-section"]:has(.mcc-landing-footer):not(#product_merch_mobile *),
    body.template-product .shopify-section:has(.mcc-landing-footer):not(#product_merch_mobile *){ 
      display: none !important; 
      visibility: hidden !important;
      opacity: 0 !important;
      z-index: -999 !important;
      height: 0 !important;
      overflow: hidden !important;
      pointer-events: none !important;
    }
    
    /* Footer inside drawer should be visible and properly styled */
    #product_merch_mobile .mm-content .mcc-landing-footer,
    #product_merch_mobile .mm-content [data-mcc-landing="footer"],
    #product_merch_mobile .mm-content section.mcc-landing-footer,
    #product_merch_mobile .mm-content .mcc-footer-in-drawer .mcc-landing-footer {
      display: block !important;
      visibility: visible !important;
      opacity: 1 !important;
      z-index: auto !important;
      position: relative !important;
      height: auto !important;
      overflow: visible !important;
      pointer-events: auto !important;
      margin-top: 32px; /* Add spacing above footer in drawer */
      /* Ensure background image/video is preserved */
      background-color: transparent !important;
      padding: 60px 20px 40px !important; /* Adjust padding for mobile drawer */
      width: 100% !important;
      max-width: 100% !important;
      margin-left: 0 !important;
      margin-right: 0 !important;
    }
    
    /* Ensure footer background image/video shows in drawer - preserve original styles */
    #product_merch_mobile .mm-content .mcc-landing-footer,
    #product_merch_mobile .mm-content [data-mcc-landing="footer"] {
      /* Ensure the footer maintains its background styling from mcc-landing-footer.liquid */
      position: relative !important;
    }
    
    #product_merch_mobile .mm-content .mcc-landing-footer::before,
    #product_merch_mobile .mm-content [data-mcc-landing="footer"]::before {
      /* The footer's own CSS should handle this, but ensure it's visible and positioned correctly */
      content: '' !important;
      display: block !important;
      position: absolute !important;
      top: 0 !important;
      left: 0 !important;
      right: 0 !important;
      bottom: 0 !important;
      z-index: -1 !important;
    }
    
    /* Ensure footer wrapper is centered and full width */
    #product_merch_mobile .mm-content .mcc-footer-wrapper {
      width: 100% !important;
      max-width: 100% !important;
      margin: 0 auto !important;
      padding: 0 !important;
      display: grid !important;
      grid-template-columns: 1fr 2fr !important;
      gap: 32px !important;
      align-items: start !important;
    }
    
    /* On very small screens, stack footer columns */
    @media (max-width: 480px) {
      #product_merch_mobile .mm-content .mcc-footer-wrapper {
        grid-template-columns: 1fr !important;
        gap: 24px !important;
      }
    }
    
    /* Footer container should be full width - break out of drawer padding */
    #product_merch_mobile .mm-content .mcc-footer-in-drawer,
    #product_merch_mobile .mm-content #merch-mobile-footer-container {
      width: calc(100% + 64px) !important; /* 100% + left padding (32px) + right padding (32px) */
      max-width: calc(100% + 64px) !important;
      margin-left: -32px !important; /* Break out of product-sections left padding */
      margin-right: -32px !important; /* Break out of product-sections right padding */
      padding: 0 !important;
      background: transparent !important; /* Override content-section white background */
      position: relative !important;
    }
    
    /* Ensure footer inside drawer doesn't get white background from content-section */
    #product_merch_mobile .mm-content .mcc-footer-in-drawer .mcc-landing-footer,
    #product_merch_mobile .mm-content #merch-mobile-footer-container .mcc-landing-footer {
      background: transparent !important; /* Let the ::before handle the background */
      margin: 0 !important;
      width: 100% !important;
      max-width: 100% !important;
    }
  }

  /* Announcement Bar lift for merch mobile template */
  @media (max-width: 749px){
    body.template-product-merch .announcement-bar{
      position: sticky;
      top: 0;
      z-index: 9999 !important;
    }
  }

  /* Reviews badge small tweaks */
  .product-merch-mobile .pdp-reviews-badge-wrap .jdgm-widget{ display:inline-block; }

  /* Wishlist fallback button styles */
  .product-merch-mobile .mm-wishlist-row { padding-top: .25rem; }
  .product-merch-mobile .mm-wishlist-inner { display:flex; }
  .product-merch-mobile .mm-fave-btn{
    display:inline-flex; gap:.5rem; align-items:center; justify-content:center;
    width:auto; min-height:44px; padding:.6rem .9rem;
    border-radius:999px; border:1px solid #ddd; background:#fff; font-size:16px;
  }
  .product-merch-mobile .mm-fave-btn.is-active{ border-color:#000; }
  .product-merch-mobile .mm-fave-icon{ transform: translateY(-1px); }
</style>

<script>
  // Move footer into drawer on merch mobile pages
  document.addEventListener('DOMContentLoaded', function () {
    if (!window.matchMedia('(max-width: 749px)').matches) return;
    
    var drawerContent = document.querySelector('#product_merch_mobile .mm-content');
    var footerContainer = document.querySelector('#merch-mobile-footer-container');
    
    if (!drawerContent || !footerContainer) return;
    
    // Find the footer outside the drawer
    var footer = document.querySelector('.mcc-landing-footer, [data-mcc-landing="footer"], section.mcc-landing-footer');
    
    // Also check parent sections
    if (!footer) {
      var footerSection = document.querySelector('[id*="shopify-section"]:has(.mcc-landing-footer), .shopify-section:has(.mcc-landing-footer)');
      if (footerSection) {
        footer = footerSection.querySelector('.mcc-landing-footer, [data-mcc-landing="footer"]');
      }
    }
    
    if (footer && !footer.closest('#product_merch_mobile')) {
      // Clone the footer to move into drawer (deep clone to preserve all elements including video)
      var footerClone = footer.cloneNode(true);
      footerClone.removeAttribute('id'); // Remove any IDs to avoid duplicates
      
      // Add a class to identify it as the drawer footer
      footerClone.classList.add('mcc-footer-in-drawer');
      
      // Ensure the clone maintains all styles and background elements
      footerClone.style.display = 'block';
      footerClone.style.visibility = 'visible';
      footerClone.style.opacity = '1';
      
      // Insert into drawer
      footerContainer.appendChild(footerClone);
      
      // Re-initialize video if it exists in the cloned footer
      var clonedVideo = footerClone.querySelector('.mcc-footer-video-bg');
      if (clonedVideo) {
        // Re-set video attributes to ensure it plays
        clonedVideo.setAttribute('autoplay', 'true');
        clonedVideo.setAttribute('loop', 'true');
        clonedVideo.setAttribute('muted', 'true');
        clonedVideo.setAttribute('playsinline', 'true');
        // Try to play the video
        if (clonedVideo.play) {
          clonedVideo.play().catch(function(e) {
            console.log('Footer video autoplay prevented:', e);
          });
        }
      }
      
      // Ensure footer background image is preserved - check if ::before has background
      // The footer's own CSS should handle this, but ensure styles are applied
      setTimeout(function() {
        var footerElement = footerContainer.querySelector('.mcc-landing-footer, [data-mcc-landing="footer"]');
        if (footerElement) {
          // Force reflow to ensure ::before pseudo-element is rendered
          footerElement.offsetHeight;
          // Ensure the footer maintains its styling
          footerElement.style.position = 'relative';
          footerElement.style.overflow = 'hidden';
          footerElement.style.background = 'transparent';
          
          // Get background image from original footer's ::before if available
          var originalFooter = footer;
          if (originalFooter) {
            try {
              var originalComputed = window.getComputedStyle(originalFooter, '::before');
              var originalBgImage = originalComputed.backgroundImage;
              if (originalBgImage && originalBgImage !== 'none' && originalBgImage !== '') {
                // Copy the background image to the cloned footer's ::before
                // Since we can't directly set ::before, we'll ensure the footer's CSS applies
                // The footer's own CSS should handle this via the ::before pseudo-element
              }
            } catch(e) {
              // ::before might not be accessible, that's okay - footer CSS should handle it
            }
          }
        }
      }, 100);
      
      // Hide the original footer outside the drawer
      var originalSection = footer.closest('[id*="shopify-section"], .shopify-section');
      if (originalSection && !originalSection.closest('#product_merch_mobile')) {
        originalSection.style.display = 'none';
        originalSection.style.visibility = 'hidden';
        originalSection.style.opacity = '0';
        originalSection.style.height = '0';
        originalSection.style.overflow = 'hidden';
        originalSection.style.pointerEvents = 'none';
      } else {
        footer.style.display = 'none';
        footer.style.visibility = 'hidden';
        footer.style.opacity = '0';
        footer.style.height = '0';
        footer.style.overflow = 'hidden';
        footer.style.pointerEvents = 'none';
      }
    }
  });
</script>

{{ 'mcc-merch-mobile.css' | asset_url | stylesheet_tag }}
<script src="{{ 'mcc-merch-mobile.js' | asset_url }}?v={{ 'now' | date: '%s' }}" defer></script>
<script>
  // Force cache clear - verify new code is loaded
  console.log('[MCC Drawer] JS loaded at', new Date().toISOString());
  console.log('[MCC Drawer] Sheet init flag:', '__mccSheetInited');
</script>



<script>
  /* MCC merch — safety reset on load */
/*
(function () {
  var html = document.documentElement, body = document.body;
  html.classList.remove('mm-locked');
  body.classList.remove('mm-locked');
  body.style.position=''; body.style.top=''; body.style.left=''; body.style.right='';
  var d = document.querySelector('.mm-drawer');
  var ov = document.querySelector('[data-mm-overlay]');
  if (d) d.classList.remove('is-open');
  if (ov) ov.style.display = 'none';
})();*/
</script>



<script>
  /* Clear locks when leaving / bfcache events */
/*
(function () {
  function clearLocks() {
    var html = document.documentElement, body = document.body;
    html.classList.remove('mm-locked');
    body.classList.remove('mm-locked');
    body.style.position=''; body.style.top=''; body.style.left=''; body.style.right='';
  }
  window.addEventListener('pagehide', clearLocks);
  window.addEventListener('visibilitychange', function () {
    if (document.visibilityState === 'hidden') clearLocks();
  });
})();*/
</script>


<script>
/* Fallback heart toggle only (no-op if app handles UI) */
document.addEventListener('click', (e) => {
  const btn = e.target.closest('[data-mm-fave]');
  if (!btn) return;
  btn.classList.toggle('is-active');
});
</script>

{% schema %}
{
  "name": "Product — Merch (Mobile)",
  "settings": [],
  "blocks": [
    {
      "type": "wishlist",
      "name": "Wishlist / Favorites",
      "limit": 1,
      "settings": [
        { "type": "text",  "id": "label",      "label": "Accessible label", "default": "Add to favorites" },
        { "type": "range", "id": "top_margin", "label": "Top spacing (px)", "min": 0, "max": 40, "step": 4, "default": 12 }
      ]
    },
    {
      "type": "reviews_badge",
      "name": "Reviews badge (Judge.me)",
      "limit": 1,
      "settings": [
        { "type": "checkbox", "id": "show_label", "label": "Show link label", "default": false },
        { "type": "text", "id": "label_text", "label": "Label text", "default": "See all reviews" },
        { "type": "range", "id": "top_margin", "label": "Top spacing (px)", "min": 0, "max": 48, "step": 4, "default": 12 }
      ]
    }
  ],
  "presets": [{ "name": "Product — Merch (Mobile)" }]
}
{% endschema %}
