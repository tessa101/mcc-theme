{% comment %}
Product Coffee PDP — uses mcc-* snippets, adds coffee-* accordion behavior
{% endcomment %}

<section class="mcc-product product-coffee"
  data-product-id="{{ product.id }}"
  data-section="{{ section.id }}">

  <!-- Mobile Hero Image -->
  <div class="product-hero-mobile" >
    {% assign mobile_image = product.media[3] | default: product.featured_media %}
    {% if mobile_image %}
      <img
        src="{{ mobile_image | image_url: width: 800 }}"
        alt="{{ mobile_image.alt | escape }}"
        class="product-image-mobile">
    {% endif %}
  </div>

  <div class="product-container">

    <!-- Left: Gallery & Content -->
    <div class="product-main">
      {% render 'mcc-product-gallery', product: product %}

      {%- comment -%} LEFT COLUMN CONTENT (has .product-sections padding: 0 32px) {%- endcomment -%}
      {% render 'mcc-product-content', product: product %}
    </div>

    <!-- Right: Product Info Sidebar -->
    <div class="product-sidebar">
      <div class="sidebar-content">

        <!-- Product Header -->
        {% render 'mcc-product-header', product: product %}
        

        {%- comment -%} Right-rail dynamic blocks {%- endcomment -%}
        {%- for block in section.blocks -%}
          {%- if block.type == 'reviews_badge' -%}
            <div class="pdp-reviews-badge" {{ block.shopify_attributes }} style="margin-top:{{ block.settings.top_margin | default: 12 }}px">
              {%- if block.settings.show_label and block.settings.label_text != blank -%}
                <a class="pdp-reviews-badge__link" href="#reviews">{{ block.settings.label_text }}</a>
              {%- endif -%}
              <!-- Judge.me Preview Badge (metafield embed) -->
              <div class="jdgm-widget jdgm-preview-badge" data-id="{{ product.id }}">
                {{ product.metafields.judgeme.badge }}
              </div>
            </div>
          {%- endif -%}
        {%- endfor -%}

        <!-- Dynamic Price Display -->
        {% if product.available %}
          <div class="product-price-display" data-product-price>
            <span class="current-price" id="current-subtotal" >
              {{ product.selected_or_first_available_variant.price | money }}
            </span>
            {% if product.selected_or_first_available_variant.compare_at_price > product.selected_or_first_available_variant.price %}
              <span class="compare-price" id="compare-price-display">
                {{ product.selected_or_first_available_variant.compare_at_price | money }}
              </span>
            {% endif %}
          </div>
        {% endif %}

        <!-- Product Form -->
        {% render 'mcc-product-form', product: product, section: section %}
      </div>
    </div>
  </div>
</section>

<!-- Keep existing MCC assets -->
<script src="{{ 'mcc-product-functionality.js' | asset_url }}" defer></script>
{{ 'mcc-product-styles.css' | asset_url | stylesheet_tag }}

<!-- === Coffee PDP: Accordion CSS (no extra padding; relies on .product-sections) === -->
<style id="coffee-accordion-css">
/* Accordion containers */
.coffee-accordion { margin: 8px 0; }

/* Header: title on left, +/− button on right */
.coffee-acc-header { display: flex; align-items: center; width: 100%; gap: 12px; }
.coffee-acc-title {
  margin: 0;
  font: 700 24px/1.2 system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
  letter-spacing: -0.02em;
  color: #111;
}
@media (max-width: 768px){
  .coffee-acc-title{ font-size: 20px; } /* mobile */
}
.coffee-acc-trigger {
  margin-left: auto;
  position: relative;
  width: 28px; height: 28px;
  display: inline-grid; place-items: center;
  border-radius: 8px;
  background: #fff;
  cursor: pointer;
}
/* + / − icon */
.coffee-acc-trigger::before,
.coffee-acc-trigger::after {
  content: "";
  position: absolute;
  width: 12px; height: 2px;
  background: #111; border-radius: 1px;
}
.coffee-acc-trigger::after { transform: rotate(90deg); } /* + */
.coffee-acc-trigger[aria-expanded="true"]::after { opacity: 0; } /* − */

/* Panel */
.coffee-acc-panel { overflow: hidden; will-change: height; transition: height 220ms ease; }

/* Mobile-only collapsed */
@media (max-width: 767.98px) {
  .coffee-acc-panel > *:first-child { margin-top: 8px; }
  .coffee-acc-panel > *:last-child  { margin-bottom: 8px; }
}

/* Desktop: always open */
@media (min-width: 768px) {
  .coffee-acc-trigger { display: none; }
  .coffee-acc-panel   { height: auto !important; }
}


/* ===== ACC ANIMATION tokens */
:root{ --acc-ease: cubic-bezier(.22, 1, .36, 1); --acc-open:550ms; --acc-close:350ms; }

/* Remove tap highlight + keep accessible focus */
.coffee-acc-trigger{ -webkit-tap-highlight-color: transparent; }
.coffee-acc-trigger:focus{ outline: none; }
.coffee-acc-trigger:focus-visible{ outline:2px solid #0aa; outline-offset:4px; }

/* Plus → minus morph (your existing bars) */
.coffee-acc-trigger::before,
.coffee-acc-trigger::after{
  transition: transform var(--acc-open) var(--acc-ease), opacity var(--acc-open) var(--acc-ease);
}
.coffee-acc-trigger::after{ transform: rotate(90deg) scaleX(1); transform-origin:50% 50%; }
.coffee-acc-trigger[aria-expanded="true"]::after{ transform: rotate(90deg) scaleX(0); opacity:0; }

/* Height tween on the panel */
.coffee-acc-panel{ transition: height var(--acc-open) var(--acc-ease); will-change: height; }

/* Soft reveal (inner) */
@keyframes acc-in  { from{opacity:0; transform:translateY(-32px)} to{opacity:1; transform:none} }
@keyframes acc-out { from{opacity:1; transform:none} to{opacity:0; transform:translateY(-16px)} }

/* Animate the first child inside the panel (e.g., .product-description.rte) */
.coffee-acc-panel.is-opening > :first-child{ animation: acc-in var(--acc-open) var(--acc-ease) both; }
.coffee-acc-panel.is-closing{ transition-duration: var(--acc-close); }
.coffee-acc-panel.is-closing > :first-child{ animation: acc-out var(--acc-close) var(--acc-ease) both; }

/* Optional stagger for multi-row sections:
   Add data-stagger="rows" to the <section> when you want it. */
[data-stagger="rows"] .coffee-acc-panel.is-opening > :first-child > *{
  opacity:0; transform:translateY(-16px);
  animation: acc-in var(--acc-open) var(--acc-ease) both;
}
[data-stagger="rows"] .coffee-acc-panel.is-opening > :first-child > *:nth-child(1){ animation-delay:0ms; }
[data-stagger="rows"] .coffee-acc-panel.is-opening > :first-child > *:nth-child(2){ animation-delay:100ms; }
[data-stagger="rows"] .coffee-acc-panel.is-opening > :first-child > *:nth-child(3){ animation-delay:160ms; }
[data-stagger="rows"] .coffee-acc-panel.is-opening > :first-child > *:nth-child(4){ animation-delay:280ms; }
/* extend nth-child if needed */

/* Respect reduced motion */
@media (prefers-reduced-motion: reduce){
  .coffee-acc-panel{ transition:none !important; }
  .coffee-acc-panel *{ animation:none !important; }
}


/* Screen-reader helper */
.sr-only {
  position: absolute; width:1px; height:1px; padding:0; margin:-1px;
  overflow:hidden; clip:rect(0,0,1px,1px); white-space:nowrap; border:0;
}

/* Hide ONLY snippet-level headings inside panels (to avoid duplicates) */
.coffee-acc-panel .brew-title,
.coffee-acc-panel .flavor-title,
.coffee-acc-panel .growing-details h3,
.coffee-acc-panel .description-section h3 { display: none !important; }
</style>

{%- comment -%} Recharge UI tweaks (unchanged) {%- endcomment -%}
<style id="recharge-tweaks">
  recharge-subscription-widget[data-hide-badge]::part(rc-purchase-option__badge) { display: none !important; }
  recharge-subscription-widget::part(rc-purchase-option__badge) { display: inline-block !important; }
  recharge-subscription-widget[data-hide-badge]::part(rc-purchase-option__badge) { display: none !important; }
  recharge-subscription-widget::part(rc-purchase-option__badge) { display: none !important; }
  recharge-subscription-widget[data-one-time]::part(rc-purchase-option__badge) { display: inline-block !important; }
  recharge-subscription-widget::part(rc-plans-button-group) {
    --rc-widget-brand-color: #d4f5d0;
    --rc-widget-brand-contrast-color: #0a5c2d;
  }
  recharge-subscription-widget::part(rc-plans-button) .rc-plans-button__discount,
  recharge-subscription-widget::part(rc-plans-button) [part="rc-plans-button__discount"] {
    color: #2e8b57 !important;
  }
  .pdp-reviews-badge { display:flex; align-items:center; gap:8px; }
  .pdp-reviews-badge__link { font-size:.875rem; text-decoration:underline; }
</style>

<!-- REVIEWS heading override (keep our title, hide Judge.me's internal title) -->
<style id="coffee-reviews-css">
.pdp-reviews .coffee-reviews-title {
  display: block !important;
  margin: 0 0 16px !important;
  font: 700 20px/1.2 system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
  letter-spacing: -0.02em;
  color: #111;
}
.pdp-reviews .jdgm-widget .jdgm-rev-widg__title,
.pdp-reviews .jdgm-widget h1.jdgm-rev-widg__title,
.pdp-reviews .jdgm-widget h2.jdgm-rev-widg__title { display: none !important; }
.pdp-reviews .jdgm-widget { margin-top: 0 !important; padding-top: 0 !important; }
</style>

<style id="recs-only-once">
/* Always show the Recommendations header (no duplicates, no hiding) */
#recommendations :is(h1,h2,h3,.recommended-products__title,.recs-title,.pdp-h2) {
  display: block !important;
}

/* Tighten top spacing above the section & header row */
#recommendations { margin-top: 8px !important; padding-top: 0 !important; }
#recommendations .recommended-products__header,
#recommendations .recs-header {
  display: flex !important;
  align-items: center !important;
  justify-content: space-between !important;
  gap: 12px !important;
  margin: 0 0 12px !important;
  padding: 0 !important;
}

/* Ensure the product grid starts tight under the header */
#recommendations .recommended-products__grid,
#recommendations .recs-grid,
#recommendations .grid {
  margin-top: 0 !important;
  padding-top: 0 !important;
}

/* Mobile-only type scale */
@media (max-width: 768px) {
  #recommendations :is(h1,h2,h3,.recommended-products__title,.recs-title,.pdp-h2) {
    margin: 0 0 12px !important;
    font-weight: 700 !important;
    font-size: 20px !important;   /* change to 20px if you prefer */
    line-height: 1.2 !important;
    letter-spacing: -0.02em !important;
    color: #111 !important;
  }
}
</style>



<!-- Initialize MCC product (unchanged) -->
<script>
document.addEventListener('DOMContentLoaded', function() {
  if (window.MCCProduct) {
    window.MCCProduct.init({
      productId: {{ product.id }},
      sectionId: '{{ section.id }}',
      selectedVariantId: {{ product.selected_or_first_available_variant.id }},
      price: {{ product.selected_or_first_available_variant.price }}
    });
  }
});
</script>

<script>
/* Recharge badge click behavior (unchanged) */
(function () {
  function handleClick(e) {
    if (!e.composedPath) return;
    const path = e.composedPath();
    const host = path.find(el => el && el.tagName === 'RECHARGE-SUBSCRIPTION-WIDGET');
    if (!host) return;
    const label = path.find(el => el?.getAttribute && el.getAttribute('part') === 'rc-purchase-option__label');
    if (!label) return;
    const isSubscription = /subscribe/i.test(label.textContent || '');
    if (isSubscription) { host.removeAttribute('data-one-time'); }
    else { host.setAttribute('data-one-time', ''); }
  }
  document.addEventListener('click', handleClick, true);
})();
</script>

<!-- === Coffee PDP: Accordion init (mobile only, resize-safe) === -->
<script>
(() => {
  const mq = window.matchMedia('(max-width: 767.98px)');
  const sections = Array.from(document.querySelectorAll('.coffee-accordion'));
  const observers = new WeakMap();

  function setPanelHeight(panel, expanded) {
    const reduce = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
    if (reduce) { panel.style.height = expanded ? 'auto' : '0px'; return; }

    if (expanded) {
      panel.style.height = 'auto';
      const h = panel.getBoundingClientRect().height;
      panel.style.height = '0px';
      panel.offsetHeight;            // reflow
      panel.style.height = h + 'px'; // animate open
    } else {
      panel.style.height = panel.getBoundingClientRect().height + 'px';
      panel.offsetHeight;            // reflow
      panel.style.height = '0px';    // animate close
    }
  }

  function observeWhileOpen(btn, panel) {
    if (!('ResizeObserver' in window)) return;
    if (observers.has(panel)) { observers.get(panel).disconnect(); observers.delete(panel); }

    const ro = new ResizeObserver(() => {
      if (btn.getAttribute('aria-expanded') === 'true') {
        panel.style.height = 'auto';
        const h = panel.getBoundingClientRect().height;
        panel.style.height = h + 'px';
      }
    });
    ro.observe(panel);
    observers.set(panel, ro);
  }

  function initMobile() {
    sections.forEach((sec) => {
      const btn   = sec.querySelector('.coffee-acc-trigger');
      const panel = sec.querySelector('.coffee-acc-panel');
      if (!btn || !panel) return;

      // start collapsed on mobile
      btn.setAttribute('aria-expanded', 'false');
      panel.style.height = '0px';

      // click binding
      if (btn._coffeeClick) btn.removeEventListener('click', btn._coffeeClick);
      btn._coffeeClick = () => {
        const expanded = btn.getAttribute('aria-expanded') === 'true';

        if (expanded) {
          // start CLOSE
          panel.classList.remove('is-opening');
          panel.classList.add('is-closing');
          btn.setAttribute('aria-expanded', 'false');
          setPanelHeight(panel, false);
        } else {
          // start OPEN
          panel.classList.remove('is-closing');
          panel.classList.add('is-opening');
          btn.setAttribute('aria-expanded', 'true');
          setPanelHeight(panel, true);
        }
      };
      btn.addEventListener('click', btn._coffeeClick);

      // transition end
      if (panel._coffeeTE) panel.removeEventListener('transitionend', panel._coffeeTE);
      panel._coffeeTE = (e) => {
        if (e.propertyName !== 'height') return;
        const expanded = btn.getAttribute('aria-expanded') === 'true';
        if (expanded) {
          // finished OPEN
          panel.style.height = 'auto';
          panel.classList.remove('is-opening');
          observeWhileOpen(btn, panel);
        } else {
          // finished CLOSE
          panel.classList.remove('is-closing');
        }
      };
      panel.addEventListener('transitionend', panel._coffeeTE);
    }); // <-- closes sections.forEach
  } // <-- closes initMobile

  function destroyMobile() {
    sections.forEach((sec) => {
      const btn   = sec.querySelector('.coffee-acc-trigger');
      const panel = sec.querySelector('.coffee-acc-panel');
      if (!btn || !panel) return;

      btn.setAttribute('aria-expanded', 'true');
      panel.style.height = 'auto';

      if (observers.has(panel)) {
        observers.get(panel).disconnect();
        observers.delete(panel);
      }
    });
  }

  const handleMQ = (e) => (e.matches ? initMobile() : destroyMobile());
  handleMQ(mq);
  mq.addEventListener('change', handleMQ);

  // safety: if a panel is open on load, sync its height
  window.addEventListener('load', () => {
    if (!mq.matches) return;
    sections.forEach((sec) => {
      const btn   = sec.querySelector('.coffee-acc-trigger');
      const panel = sec.querySelector('.coffee-acc-panel');
      if (!btn || !panel) return;
      if (btn.getAttribute('aria-expanded') === 'true') {
        panel.style.height = 'auto';
        const h = panel.getBoundingClientRect().height;
        panel.style.height = h + 'px';
      }
    });
  });
})();
</script>


{% schema %}
{
  "name": "product-coffee",
  "tag": "section",
  "class": "section",
  "limit": 1,
  "settings": [
    { "type": "checkbox", "id": "show_shipping_info", "label": "Show shipping information", "default": true },
    { "type": "checkbox", "id": "enable_image_zoom", "label": "Enable image zoom on hover", "default": false }
  ],
  "blocks": [
    { "type": "@app" },

    {
      "type": "reviews_badge",
      "name": "Reviews badge (Judge.me)",
      "limit": 1,
      "settings": [
        { "type": "checkbox", "id": "show_label", "label": "Show link label", "default": false },
        { "type": "text", "id": "label_text", "label": "Label text", "default": "See all reviews" },
        { "type": "range", "id": "top_margin", "label": "Top spacing (px)", "min": 0, "max": 48, "step": 4, "default": 12 }
      ]
    },

    { "type": "title", "name": "Product Title", "limit": 1 },
    { "type": "price", "name": "Product Price", "limit": 1 },
    { "type": "variant_picker", "name": "Variant Picker", "limit": 1 },

    {
      "type": "quantity_selector",
      "name": "Quantity Selector",
      "limit": 1,
      "settings": [
        { "type": "text", "id": "quantity_label", "label": "Quantity Label", "default": "QUANTITY" }
      ]
    },

    { "type": "buy_buttons", "name": "Buy Buttons", "limit": 1 },

    {
      "type": "wishlist",
      "name": "Wishlist / Favorites",
      "limit": 1,
      "settings": [
        { "type": "text", "id": "label", "label": "Accessible label", "default": "Add to favorites" },
        { "type": "range", "id": "top_margin", "label": "Top spacing (px)", "min": 0, "max": 40, "step": 4, "default": 12 }
      ]
    }
  ],
  "presets": [
    {
      "name": "product-coffee",
      "blocks": [
        { "type": "reviews_badge" },
        { "type": "variant_picker" },
        { "type": "quantity_selector" },
        { "type": "buy_buttons" }
      ]
    }
  ]
}
{% endschema %}
