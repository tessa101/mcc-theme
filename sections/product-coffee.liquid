{% comment %}
Product Coffee PDP — uses mcc-* snippets, adds coffee-* accordion behavior
{% endcomment %}

{%- comment -%} Detect product type {%- endcomment -%}
{% render 'mcc-product-type-detection', product: product %}

<section class="mcc-product product-coffee{% if is_cold_brew %} product-cold-brew{% endif %}"
  data-product-id="{{ product.id }}"
  data-section="{{ section.id }}"
  data-is-cold-brew="{{ is_cold_brew }}">

  <!-- Mobile Hero Image -->
  <div class="product-hero-mobile" data-hero-mobile style="opacity: 0; transform: translateY(40px); visibility: hidden;">
    {% assign mobile_image = product.media[3] | default: product.featured_media %}
    {% if mobile_image %}
      <img
        src="{{ mobile_image | image_url: width: 800 }}"
        alt="{{ mobile_image.alt | escape }}"
        class="product-image-mobile"
        width="{{ mobile_image.width }}"
        height="{{ mobile_image.height }}"
        loading="eager">
    {% endif %}
  </div>

  <div class="product-container">

    <!-- Left: Gallery & Content -->
    <div class="product-main">
      {%- comment -%} LEFT RAIL BLOCKS: Gallery and Content Sections {%- endcomment -%}
      {%- assign has_left_rail_blocks = false -%}
      {%- for block in section.blocks -%}
        {%- if block.type == 'gallery' or block.type == 'details' or block.type == 'description' or block.type == 'flavor_profile' or block.type == 'growing_details' or block.type == 'brewing_methods' or block.type == 'reviews' or block.type == 'recommendations' -%}
          {%- assign has_left_rail_blocks = true -%}
          {%- break -%}
        {%- endif -%}
      {%- endfor -%}
      
      {%- if has_left_rail_blocks -%}
        {%- assign content_sections_started = false -%}
        {%- for block in section.blocks -%}
          {%- case block.type -%}
            {%- when 'gallery' -%}
              {%- case block.settings.variant -%}
                {%- when 'grid' -%}
                  {% render 'mcc-product-gallery-grid', product: product, block: block, section: section %}
                {%- when 'hero' -%}
                  {% render 'mcc-product-gallery-hero', product: product, block: block, section: section %}
                {%- when 'carousel' -%}
                  {% render 'mcc-product-gallery-carousel', product: product, block: block, section: section %}
                {%- when 'vertical' -%}
                  {% render 'mcc-product-gallery-vertical', product: product, block: block, section: section %}
                {%- else -%}
                  {% render 'mcc-product-gallery-grid', product: product, block: block, section: section %}
              {%- endcase -%}
            {%- when 'details' -%}
              {%- unless content_sections_started -%}
                <div class="product-sections">
                {%- assign content_sections_started = true -%}
              {%- endunless -%}
              {% render 'mcc-product-content-details', product: product, block: block, section: section %}
            {%- when 'description' -%}
              {%- unless content_sections_started -%}
                <div class="product-sections">
                {%- assign content_sections_started = true -%}
              {%- endunless -%}
              {% render 'mcc-product-content-description', product: product, block: block, section: section %}
            {%- when 'flavor_profile' -%}
              {%- unless content_sections_started -%}
                <div class="product-sections">
                {%- assign content_sections_started = true -%}
              {%- endunless -%}
              {% render 'mcc-product-content-flavor', product: product, block: block, section: section %}
            {%- when 'growing_details' -%}
              {%- unless content_sections_started -%}
                <div class="product-sections">
                {%- assign content_sections_started = true -%}
              {%- endunless -%}
              {% render 'mcc-product-content-growing', product: product, block: block, section: section %}
            {%- when 'brewing_methods' -%}
              {%- unless content_sections_started -%}
                <div class="product-sections">
                {%- assign content_sections_started = true -%}
              {%- endunless -%}
              {% render 'mcc-product-content-brewing', product: product, block: block, section: section %}
            {%- when 'reviews' -%}
              {%- unless content_sections_started -%}
                <div class="product-sections">
                {%- assign content_sections_started = true -%}
              {%- endunless -%}
              {% render 'mcc-product-content-reviews', product: product, block: block, section: section %}
            {%- when 'recommendations' -%}
              {%- unless content_sections_started -%}
                <div class="product-sections">
                {%- assign content_sections_started = true -%}
              {%- endunless -%}
              {% render 'mcc-product-content-recommendations', product: product, block: block, section: section %}
          {%- endcase -%}
        {%- endfor -%}
        {%- if content_sections_started -%}
          </div>
        {%- endif -%}
      {%- else -%}
        {%- comment -%} Fallback: render old hardcoded content if no blocks configured {%- endcomment -%}
        {%- comment -%} This ensures content always shows even if blocks aren't set up yet {%- endcomment -%}
        {% render 'mcc-product-gallery', product: product %}
        <div class="product-sections">
          {% render 'mcc-product-content', product: product %}
        </div>
      {%- endif -%}
    </div>

    <!-- Right: Product Info Sidebar -->
    <div class="product-sidebar">
      <div class="sidebar-content">

        <!-- Product Header -->
        {% render 'mcc-product-header', product: product %}
        

        {%- comment -%} Right-rail dynamic blocks {%- endcomment -%}
        {%- for block in section.blocks -%}
          {%- case block.type -%}
            {%- when 'reviews_badge' -%}
              {%- assign badge_content = product.metafields.judgeme.badge -%}
              {%- if badge_content != blank -%}
                <div class="pdp-reviews-badge" {{ block.shopify_attributes }} style="margin-top:{{ block.settings.top_margin | default: 12 }}px">
                  {%- if block.settings.show_label and block.settings.label_text != blank -%}
                    <a class="pdp-reviews-badge__link" href="#reviews">{{ block.settings.label_text }}</a>
                  {%- endif -%}
                  <!-- Judge.me Preview Badge (metafield embed) -->
                  <div class="jdgm-widget jdgm-preview-badge" data-id="{{ product.id }}">
                    {{ badge_content }}
                  </div>
                </div>
              {%- else -%}
                <div class="pdp-reviews-badge" {{ block.shopify_attributes }} style="display: none;">
                </div>
              {%- endif -%}

            {%- when 'price' -%}
              {%- comment -%} Price block - hidden for cold brew by default, can be shown via Shopify admin block visibility {%- endcomment -%}
              {% unless is_cold_brew %}
                {% if product.available %}
                  <div class="product-price-display" data-product-price {{ block.shopify_attributes }}>
                    <span class="current-price" id="current-subtotal" >
                      {{ product.selected_or_first_available_variant.price | money }}
                    </span>
                    {% if product.selected_or_first_available_variant.compare_at_price > product.selected_or_first_available_variant.price %}
                      <span class="compare-price" id="compare-price-display">
                        {{ product.selected_or_first_available_variant.compare_at_price | money }}
                      </span>
                    {% endif %}
                  </div>
                {% endif %}
              {% endunless %}
          {%- endcase -%}
        {%- endfor -%}

        <!-- Product Form -->
        {% render 'mcc-product-form', product: product, section: section %}
      </div>
    </div>
  </div>
</section>

<!-- Keep existing MCC assets -->
<script src="{{ 'mcc-product-functionality.js' | asset_url }}" defer></script>
{{ 'mcc-product-styles.css' | asset_url | stylesheet_tag }}

{%- style -%}
  /* Override .product-container margin-top (was 80px, now 0 since header margin-bottom handles spacing) */
  html:not(.mcc-merch-mode) .product-container {
    margin-top: 0 !important;
  }
{%- endstyle -%}

<script>
  document.addEventListener('DOMContentLoaded', function () {
    document.body.classList.add('layout-coffee');

    const elevateCartDrawer = () => {
      const drawerSection = document.querySelector('.shopify-section-cart-drawer');
      if (!drawerSection) return;

      drawerSection.style.position = 'fixed';
      drawerSection.style.top = '0';
      drawerSection.style.left = '0';
      drawerSection.style.width = '100%';
      drawerSection.style.zIndex = '12000';
      drawerSection.style.pointerEvents = 'none';

      const cartDrawer = drawerSection.querySelector('cart-drawer');
      if (cartDrawer) {
        cartDrawer.style.zIndex = '12000';
        cartDrawer.style.pointerEvents = 'auto';
      }

      const drawer = drawerSection.querySelector('.drawer');
      if (drawer) {
        drawer.style.zIndex = '12000';
      }

      const overlay = drawerSection.querySelector('.cart-drawer__overlay');
      if (overlay) {
        overlay.style.zIndex = '12000';
      }
    };

    elevateCartDrawer();
    document.addEventListener('shopify:section:load', elevateCartDrawer);
  });
</script>

<!-- Cart Drawer Z-Index Fix (loads after component-cart-drawer.css) -->
<style>
/* === Cart Drawer Layer Fix (for Coffee/Cold Brew) === */
/* Global selectors to override component-cart-drawer.css (z-index 1300) */
/* This inline style loads in the section, ensuring it overrides head CSS */
cart-drawer,
#CartDrawer,
[data-cart-drawer] {
  z-index: 12000 !important;
}

/* Override .drawer class z-index from component-cart-drawer.css */
.drawer {
  z-index: 12000 !important;
}

/* Ensure header stays above other content but below cart drawer */
.header-wrapper {
  z-index: 2000 !important;
}

.section-header.shopify-section-group-header-group {
  z-index: 2000 !important;
}

header.header,
#shopify-section-header {
  z-index: 2000 !important;
}
</style>

<!-- === Coffee PDP: Mobile Hero Image Animation === -->
<style id="coffee-mobile-hero-animation">
/* Mobile hero image fade-up animation (matching gallery pattern) */
@media (max-width: 768px) {
  .product-hero-mobile[data-hero-mobile] {
    opacity: 0 !important;
    transform: translateY(40px) !important;
    visibility: hidden !important;
    transition: opacity 0.8s cubic-bezier(0.33, 0.02, 0.1, 1),
                transform 0.8s cubic-bezier(0.33, 0.02, 0.1, 1),
                visibility 0s 0.8s !important;
    transition-delay: 0.3s !important;
    will-change: opacity, transform;
  }

  .product-hero-mobile[data-hero-mobile].is-inview {
    opacity: 1 !important;
    transform: none !important;
    visibility: visible !important;
    transition-delay: 0.3s !important;
  }
}

/* Respect reduced motion */
@media (prefers-reduced-motion: reduce) {
  .product-hero-mobile[data-hero-mobile] {
    opacity: 1 !important;
    transform: none !important;
    visibility: visible !important;
    transition: none !important;
  }
}
</style>

<!-- === Coffee PDP: Accordion CSS (no extra padding; relies on .product-sections) === -->
<style id="coffee-accordion-css">
/* Accordion containers */
.coffee-accordion { margin: 8px 0; }

/* Header: title on left, +/− button on right */
.coffee-acc-header { display: flex; align-items: center; width: 100%; gap: 12px; }
.coffee-acc-title {
  margin: 0;
  font: 700 24px/1.2 system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
  letter-spacing: -0.02em;
  color: #111;
}
@media (max-width: 768px){
  .coffee-acc-title{ font-size: 20px; } /* mobile */
}
.coffee-acc-trigger {
  margin-left: auto;
  position: relative;
  width: 28px; height: 28px;
  display: inline-grid; place-items: center;
  border-radius: 8px;
  background: #fff;
  cursor: pointer;
}
/* + / − icon */
.coffee-acc-trigger::before,
.coffee-acc-trigger::after {
  content: "";
  position: absolute;
  width: 12px; height: 2px;
  background: #111; border-radius: 1px;
}
.coffee-acc-trigger::after { transform: rotate(90deg); } /* + */
.coffee-acc-trigger[aria-expanded="true"]::after { opacity: 0; } /* − */

/* Panel */
.coffee-acc-panel { overflow: hidden; will-change: height; transition: height 220ms ease; }

/* Mobile-only collapsed */
@media (max-width: 767.98px) {
  .coffee-acc-panel > *:first-child { margin-top: 8px; }
  .coffee-acc-panel > *:last-child  { margin-bottom: 8px; }
}

/* Desktop: always open */
@media (min-width: 768px) {
  .coffee-acc-trigger { display: none; }
  .coffee-acc-panel   { height: auto !important; }
}


/* ===== ACC ANIMATION tokens */
:root{ --acc-ease: cubic-bezier(.22, 1, .36, 1); --acc-open:550ms; --acc-close:350ms; }

/* Remove tap highlight + keep accessible focus */
.coffee-acc-trigger{ -webkit-tap-highlight-color: transparent; }
.coffee-acc-trigger:focus{ outline: none; }
.coffee-acc-trigger:focus-visible{ outline:2px solid #0aa; outline-offset:4px; }

/* Plus → minus morph (your existing bars) */
.coffee-acc-trigger::before,
.coffee-acc-trigger::after{
  transition: transform var(--acc-open) var(--acc-ease), opacity var(--acc-open) var(--acc-ease);
}
.coffee-acc-trigger::after{ transform: rotate(90deg) scaleX(1); transform-origin:50% 50%; }
.coffee-acc-trigger[aria-expanded="true"]::after{ transform: rotate(90deg) scaleX(0); opacity:0; }

/* Height tween on the panel */
.coffee-acc-panel{ transition: height var(--acc-open) var(--acc-ease); will-change: height; }

/* Soft reveal (inner) */
@keyframes acc-in  { from{opacity:0; transform:translateY(-32px)} to{opacity:1; transform:none} }
@keyframes acc-out { from{opacity:1; transform:none} to{opacity:0; transform:translateY(-16px)} }

/* Animate the first child inside the panel (e.g., .product-description.rte) */
.coffee-acc-panel.is-opening > :first-child{ animation: acc-in var(--acc-open) var(--acc-ease) both; }
.coffee-acc-panel.is-closing{ transition-duration: var(--acc-close); }
.coffee-acc-panel.is-closing > :first-child{ animation: acc-out var(--acc-close) var(--acc-ease) both; }

/* Optional stagger for multi-row sections:
   Add data-stagger="rows" to the <section> when you want it. */
[data-stagger="rows"] .coffee-acc-panel.is-opening > :first-child > *{
  opacity:0; transform:translateY(-16px);
  animation: acc-in var(--acc-open) var(--acc-ease) both;
}
[data-stagger="rows"] .coffee-acc-panel.is-opening > :first-child > *:nth-child(1){ animation-delay:0ms; }
[data-stagger="rows"] .coffee-acc-panel.is-opening > :first-child > *:nth-child(2){ animation-delay:100ms; }
[data-stagger="rows"] .coffee-acc-panel.is-opening > :first-child > *:nth-child(3){ animation-delay:160ms; }
[data-stagger="rows"] .coffee-acc-panel.is-opening > :first-child > *:nth-child(4){ animation-delay:280ms; }
/* extend nth-child if needed */

/* Respect reduced motion */
@media (prefers-reduced-motion: reduce){
  .coffee-acc-panel{ transition:none !important; }
  .coffee-acc-panel *{ animation:none !important; }
}


/* Screen-reader helper */
.sr-only {
  position: absolute; width:1px; height:1px; padding:0; margin:-1px;
  overflow:hidden; clip:rect(0,0,1px,1px); white-space:nowrap; border:0;
}

/* Hide ONLY snippet-level headings inside panels (to avoid duplicates) */
.coffee-acc-panel .brew-title,
.coffee-acc-panel .flavor-title,
.coffee-acc-panel .growing-details h3,
.coffee-acc-panel .description-section h3 { display: none !important; }
</style>

<!-- === Coffee PDP: Left Blocks Scroll Animation (matching gallery) === -->
<style id="coffee-blocks-scroll-animation">
/* Initial hidden state for all content blocks (matching gallery exactly) */
.product-sections .coffee-accordion {
  opacity: 0 !important;
  transform: translateY(40px) !important;
  transition: opacity 0.8s cubic-bezier(0.33, 0.02, 0.1, 1),
              transform 0.8s cubic-bezier(0.33, 0.02, 0.1, 1);
}

/* Visible state when scrolled into view (matching gallery exactly) */
.product-sections .coffee-accordion.is-inview {
  opacity: 1 !important;
  transform: none !important;
}

/* First block fades in with delay - no longer immediately visible */
.product-sections .coffee-accordion:first-child {
  /* Remove immediate visibility - let animation handle it */
  transition-delay: 0.15s !important; /* Match sidebar delay */
}

/* Respect reduced motion */
@media (prefers-reduced-motion: reduce) {
  .product-sections .coffee-accordion {
    opacity: 1 !important;
    transform: none !important;
    transition: none !important;
  }
}
</style>

{%- comment -%} Recharge UI tweaks (unchanged) {%- endcomment -%}
<style id="recharge-tweaks">
  recharge-subscription-widget[data-hide-badge]::part(rc-purchase-option__badge) { display: none !important; }
  recharge-subscription-widget::part(rc-purchase-option__badge) { display: inline-block !important; }
  recharge-subscription-widget[data-hide-badge]::part(rc-purchase-option__badge) { display: none !important; }
  recharge-subscription-widget::part(rc-purchase-option__badge) { display: none !important; }
  recharge-subscription-widget[data-one-time]::part(rc-purchase-option__badge) { display: inline-block !important; }
  recharge-subscription-widget::part(rc-plans-button-group) {
    --rc-widget-brand-color: #d4f5d0;
    --rc-widget-brand-contrast-color: #0a5c2d;
  }
  recharge-subscription-widget::part(rc-plans-button) .rc-plans-button__discount,
  recharge-subscription-widget::part(rc-plans-button) [part="rc-plans-button__discount"] {
    color: #2e8b57 !important;
  }
  .pdp-reviews-badge { display:flex; align-items:center; gap:8px; }
  .pdp-reviews-badge__link { font-size:.875rem; text-decoration:underline; }
  /* Hide margin when badge is empty or not displayed */
  .pdp-reviews-badge:has(.jdgm-preview-badge[style*="display: none"]),
  .pdp-reviews-badge:has(.jdgm-preview-badge:empty),
  .pdp-reviews-badge:not(:has(.jdgm-preview-badge *)) {
    margin-top: 0 !important;
    display: none !important;
  }
</style>

<!-- REVIEWS heading override (keep our title, hide Judge.me's internal title) -->
<style id="coffee-reviews-css">
.pdp-reviews .coffee-reviews-title {
  display: block !important;
  margin: 0 0 16px !important;
  font: 700 20px/1.2 system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
  letter-spacing: -0.02em;
  color: #111;
}
.pdp-reviews .jdgm-widget .jdgm-rev-widg__title,
.pdp-reviews .jdgm-widget h1.jdgm-rev-widg__title,
.pdp-reviews .jdgm-widget h2.jdgm-rev-widg__title { display: none !important; }
.pdp-reviews .jdgm-widget { margin-top: 0 !important; padding-top: 0 !important; }
</style>

<style id="recs-only-once">
/* Always show the Recommendations header (no duplicates, no hiding) */
#recommendations :is(h1,h2,h3,.recommended-products__title,.recs-title,.pdp-h2) {
  display: block !important;
}

/* Tighten top spacing above the section & header row */
#recommendations { margin-top: 8px !important; padding-top: 0 !important; }
#recommendations .recommended-products__header,
#recommendations .recs-header {
  display: flex !important;
  align-items: center !important;
  justify-content: space-between !important;
  gap: 12px !important;
  margin: 0 0 12px !important;
  padding: 0 !important;
}

/* Ensure the product grid starts tight under the header */
#recommendations .recommended-products__grid,
#recommendations .recs-grid,
#recommendations .grid {
  margin-top: 0 !important;
  padding-top: 0 !important;
}

/* Mobile-only type scale */
@media (max-width: 768px) {
  #recommendations :is(h1,h2,h3,.recommended-products__title,.recs-title,.pdp-h2,.recommended-title) {
    margin: 0 0 12px !important;
    font-weight: 400 !important;
    font-size: 24px !important;
    line-height: 1.2 !important;
    letter-spacing: 0.01em !important;
    color: #222 !important;
  }
}
</style>



<!-- Initialize MCC product (unchanged) -->
<script>
document.addEventListener('DOMContentLoaded', function() {
  if (window.MCCProduct) {
    window.MCCProduct.init({
      productId: {{ product.id }},
      sectionId: '{{ section.id }}',
      selectedVariantId: {{ product.selected_or_first_available_variant.id }},
      price: {{ product.selected_or_first_available_variant.price }}
    });
  }
});
</script>

<script>
/* Recharge badge click behavior (unchanged) */
(function () {
  function handleClick(e) {
    if (!e.composedPath) return;
    const path = e.composedPath();
    const host = path.find(el => el && el.tagName === 'RECHARGE-SUBSCRIPTION-WIDGET');
    if (!host) return;
    const label = path.find(el => el?.getAttribute && el.getAttribute('part') === 'rc-purchase-option__label');
    if (!label) return;
    const isSubscription = /subscribe/i.test(label.textContent || '');
    if (isSubscription) { host.removeAttribute('data-one-time'); }
    else { host.setAttribute('data-one-time', ''); }
  }
  document.addEventListener('click', handleClick, true);
})();
</script>

<!-- === Coffee PDP: Accordion init (mobile only, resize-safe) === -->
<script>
(() => {
  const mq = window.matchMedia('(max-width: 767.98px)');
  const sections = Array.from(document.querySelectorAll('.coffee-accordion'));
  const observers = new WeakMap();

  function setPanelHeight(panel, expanded) {
    const reduce = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
    if (reduce) { panel.style.height = expanded ? 'auto' : '0px'; return; }

    if (expanded) {
      panel.style.height = 'auto';
      const h = panel.getBoundingClientRect().height;
      panel.style.height = '0px';
      panel.offsetHeight;            // reflow
      panel.style.height = h + 'px'; // animate open
    } else {
      panel.style.height = panel.getBoundingClientRect().height + 'px';
      panel.offsetHeight;            // reflow
      panel.style.height = '0px';    // animate close
    }
  }

  function observeWhileOpen(btn, panel) {
    if (!('ResizeObserver' in window)) return;
    if (observers.has(panel)) { observers.get(panel).disconnect(); observers.delete(panel); }

    const ro = new ResizeObserver(() => {
      if (btn.getAttribute('aria-expanded') === 'true') {
        panel.style.height = 'auto';
        const h = panel.getBoundingClientRect().height;
        panel.style.height = h + 'px';
      }
    });
    ro.observe(panel);
    observers.set(panel, ro);
  }

  function initMobile() {
    sections.forEach((sec) => {
      const btn   = sec.querySelector('.coffee-acc-trigger');
      const panel = sec.querySelector('.coffee-acc-panel');
      if (!btn || !panel) return;

      // start collapsed on mobile
      btn.setAttribute('aria-expanded', 'false');
      panel.style.height = '0px';

      // click binding
      if (btn._coffeeClick) btn.removeEventListener('click', btn._coffeeClick);
      btn._coffeeClick = () => {
        const expanded = btn.getAttribute('aria-expanded') === 'true';

        if (expanded) {
          // start CLOSE
          panel.classList.remove('is-opening');
          panel.classList.add('is-closing');
          btn.setAttribute('aria-expanded', 'false');
          setPanelHeight(panel, false);
        } else {
          // start OPEN
          panel.classList.remove('is-closing');
          panel.classList.add('is-opening');
          btn.setAttribute('aria-expanded', 'true');
          setPanelHeight(panel, true);
        }
      };
      btn.addEventListener('click', btn._coffeeClick);

      // transition end
      if (panel._coffeeTE) panel.removeEventListener('transitionend', panel._coffeeTE);
      panel._coffeeTE = (e) => {
        if (e.propertyName !== 'height') return;
        const expanded = btn.getAttribute('aria-expanded') === 'true';
        if (expanded) {
          // finished OPEN
          panel.style.height = 'auto';
          panel.classList.remove('is-opening');
          observeWhileOpen(btn, panel);
        } else {
          // finished CLOSE
          panel.classList.remove('is-closing');
        }
      };
      panel.addEventListener('transitionend', panel._coffeeTE);
    }); // <-- closes sections.forEach
  } // <-- closes initMobile

  function destroyMobile() {
    sections.forEach((sec) => {
      const btn   = sec.querySelector('.coffee-acc-trigger');
      const panel = sec.querySelector('.coffee-acc-panel');
      if (!btn || !panel) return;

      btn.setAttribute('aria-expanded', 'true');
      panel.style.height = 'auto';

      if (observers.has(panel)) {
        observers.get(panel).disconnect();
        observers.delete(panel);
      }
    });
  }

  const handleMQ = (e) => (e.matches ? initMobile() : destroyMobile());
  handleMQ(mq);
  mq.addEventListener('change', handleMQ);

  // safety: if a panel is open on load, sync its height
  window.addEventListener('load', () => {
    if (!mq.matches) return;
    sections.forEach((sec) => {
      const btn   = sec.querySelector('.coffee-acc-trigger');
      const panel = sec.querySelector('.coffee-acc-panel');
      if (!btn || !panel) return;
      if (btn.getAttribute('aria-expanded') === 'true') {
        panel.style.height = 'auto';
        const h = panel.getBoundingClientRect().height;
        panel.style.height = h + 'px';
      }
    });
  });
})();
</script>

<!-- === Coffee PDP: Left Blocks Scroll Animation (matching gallery) === -->
<script>
/* ===== Coffee Left Blocks — fade-up on scroll (matching gallery exactly) ===== */
(function() {
  function initBlocksScrollAnimation() {
    const productSections = document.querySelector('.product-sections');
    if (!productSections) return;
    // Allow re-initialization on reload by checking flag after finding element
    if (productSections.__mccBlocksInited) return;
    productSections.__mccBlocksInited = true;

    const blocks = Array.from(productSections.querySelectorAll('.coffee-accordion'));
    if (blocks.length === 0) return;

    // IntersectionObserver for scroll-triggered animations (exact match to gallery)
    const io = new IntersectionObserver((entries, obs) => {
      entries.forEach(entry => {
        if (entry.isIntersecting) {
          entry.target.classList.add('is-inview');
          obs.unobserve(entry.target);
        }
      });
    }, { threshold: 0.12 });

    // Set up blocks: first gets is-inview with delay, rest are observed
    blocks.forEach((el, i) => {
      if (i === 0) {
        // First block - add is-inview with slight delay to match sidebar
        // Use requestAnimationFrame to ensure it happens after CSS is applied
        requestAnimationFrame(function() {
          setTimeout(function() {
            el.classList.add('is-inview');
          }, 150); // Match sidebar delay
        });
      } else {
        // Observe subsequent blocks for scroll animation
        io.observe(el);
      }
    });
  }

  // Run immediately and on DOM ready - ensure it runs on every load
  function runInit() {
    // Try multiple times to catch the blocks when they're ready
    const productSections = document.querySelector('.product-sections');
    if (productSections) {
      // Reset flag if it exists to allow re-initialization on reload
      if (productSections.__mccBlocksInited) {
        productSections.__mccBlocksInited = false;
      }
      initBlocksScrollAnimation();
      return true;
    } else {
      // Blocks not found yet, try again soon (max 20 attempts = 1 second)
      if (runInit.attempts === undefined) runInit.attempts = 0;
      runInit.attempts++;
      if (runInit.attempts < 20) {
        setTimeout(runInit, 50);
      }
      return false;
    }
  }
  
  // Safety fallback: if blocks still not initialized after 1 second, force show first block
  setTimeout(function() {
    const productSections = document.querySelector('.product-sections');
    if (productSections) {
      const firstBlock = productSections.querySelector('.coffee-accordion:first-child');
      if (firstBlock && !firstBlock.classList.contains('is-inview')) {
        firstBlock.classList.add('is-inview');
      }
    }
  }, 1000);
  
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', runInit);
    // Also try immediately in case DOM is ready but event hasn't fired
    setTimeout(runInit, 0);
  } else {
    // DOM already ready, run immediately
    runInit();
  }

  // Also run on section load (Shopify theme editor)
  document.addEventListener('shopify:section:load', function(e) {
    const targetSections = e.target.querySelector('.product-sections') || 
                          (e.target.closest && e.target.closest('.product-sections'));
    if (targetSections) {
      // Reset initialization flag if section reloaded
      if (targetSections.__mccBlocksInited) {
        targetSections.__mccBlocksInited = false;
      }
      initBlocksScrollAnimation();
    }
  });
})();
</script>

<!-- === Coffee PDP: Mobile Hero Image Animation Init === -->
<script>
/* ===== Coffee Mobile Hero — fade-up animation (300ms delay) ===== */
(function() {
  function initMobileHeroAnimation() {
    const heroMobile = document.querySelector('.product-hero-mobile[data-hero-mobile]');
    if (!heroMobile) return;
    // Allow re-initialization on reload by checking flag after finding element
    if (heroMobile.__mccMobileHeroInited) return;
    heroMobile.__mccMobileHeroInited = true;
    
    // Add is-inview class after 300ms delay to trigger animation
    // Remove any inline styles that might interfere with CSS transitions
    requestAnimationFrame(function() {
      setTimeout(function() {
        heroMobile.style.removeProperty('opacity');
        heroMobile.style.removeProperty('transform');
        heroMobile.style.removeProperty('visibility');
        heroMobile.classList.add('is-inview');
      }, 300); // 300ms delay as specified
    });
  }

  // Run immediately and on DOM ready - ensure it runs on every load
  function runInit() {
    // Try multiple times to catch the hero when it's ready
    const heroMobile = document.querySelector('.product-hero-mobile[data-hero-mobile]');
    if (heroMobile) {
      // Reset flag if it exists to allow re-initialization on reload
      if (heroMobile.__mccMobileHeroInited) {
        heroMobile.__mccMobileHeroInited = false;
      }
      initMobileHeroAnimation();
      return true;
    } else {
      // Hero not found yet, try again soon (max 20 attempts = 1 second)
      if (runInit.attempts === undefined) runInit.attempts = 0;
      runInit.attempts++;
      if (runInit.attempts < 20) {
        setTimeout(runInit, 50);
      }
      return false;
    }
  }
  
  // Safety fallback: if hero still not initialized after 1 second, force show
  setTimeout(function() {
    const heroMobile = document.querySelector('.product-hero-mobile[data-hero-mobile]');
    if (heroMobile && !heroMobile.classList.contains('is-inview')) {
      heroMobile.style.removeProperty('opacity');
      heroMobile.style.removeProperty('transform');
      heroMobile.style.removeProperty('visibility');
      heroMobile.classList.add('is-inview');
    }
  }, 1000);
  
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', runInit);
    // Also try immediately in case DOM is ready but event hasn't fired
    setTimeout(runInit, 0);
  } else {
    // DOM already ready, run immediately
    runInit();
  }

  // Also run on section load (Shopify theme editor)
  document.addEventListener('shopify:section:load', function(e) {
    const targetHero = e.target.querySelector('.product-hero-mobile[data-hero-mobile]') || 
                      (e.target.closest && e.target.closest('.product-hero-mobile[data-hero-mobile]'));
    if (targetHero) {
      // Reset initialization flag if section reloaded
      if (targetHero.__mccMobileHeroInited) {
        targetHero.__mccMobileHeroInited = false;
      }
      targetHero.classList.remove('is-inview');
      setTimeout(function() {
        targetHero.classList.add('is-inview');
      }, 300);
    }
  });
})();
</script>


{% schema %}
{
  "name": "product-coffee",
  "tag": "section",
  "class": "section",
  "limit": 1,
  "settings": [
    { "type": "checkbox", "id": "show_shipping_info", "label": "Show shipping information", "default": true },
    { "type": "checkbox", "id": "enable_image_zoom", "label": "Enable image zoom on hover", "default": false }
  ],
  "blocks": [
    { "type": "@app" },

    {
      "type": "gallery",
      "name": "Left: Product Gallery",
      "limit": 1,
      "settings": [
        {
          "type": "select",
          "id": "variant",
          "label": "Gallery variant",
          "options": [
            { "value": "grid", "label": "3-Image Grid" },
            { "value": "hero", "label": "Single Hero Image" },
            { "value": "carousel", "label": "Carousel/Slider" },
            { "value": "vertical", "label": "Vertical Gallery" }
          ],
          "default": "grid"
        },
        {
          "type": "paragraph",
          "content": "Images are managed in the product's media section. Desktop uses the featured image, mobile uses the 4th image (if available)."
        },
        {
          "type": "header",
          "content": "Hero Image Settings"
        },
        {
          "type": "checkbox",
          "id": "enable_click_cycle",
          "label": "Enable click to cycle through images",
          "default": false,
          "info": "Only applies to hero variant"
        },
        {
          "type": "header",
          "content": "Carousel Settings"
        },
        {
          "type": "checkbox",
          "id": "autoplay",
          "label": "Enable autoplay",
          "default": false,
          "info": "Only applies to carousel variant"
        },
        {
          "type": "range",
          "id": "autoplay_speed",
          "label": "Autoplay speed (seconds)",
          "min": 3,
          "max": 10,
          "step": 1,
          "default": 5,
          "info": "Only applies to carousel variant"
        },
        {
          "type": "checkbox",
          "id": "show_arrows",
          "label": "Show navigation arrows",
          "default": true,
          "info": "Only applies to carousel variant"
        },
        {
          "type": "checkbox",
          "id": "show_dots",
          "label": "Show dot indicators",
          "default": true,
          "info": "Only applies to carousel variant"
        }
      ]
    },

    {
      "type": "details",
      "name": "Left: Details",
      "limit": 1
    },

    {
      "type": "description",
      "name": "Left: Description",
      "limit": 1
    },

    {
      "type": "flavor_profile",
      "name": "Left: Flavor Profile",
      "limit": 1
    },

    {
      "type": "growing_details",
      "name": "Left: Growing Details",
      "limit": 1
    },

    {
      "type": "brewing_methods",
      "name": "Left: Brewing Methods",
      "limit": 1,
      "settings": [
        {
          "type": "paragraph",
          "content": "Only shows for coffee bean products, not cold brew"
        }
      ]
    },

    {
      "type": "reviews",
      "name": "Left: Reviews",
      "limit": 1
    },

    {
      "type": "recommendations",
      "name": "Left: Recommendations",
      "limit": 1
    },

    {
      "type": "reviews_badge",
      "name": "Right: Reviews Badge",
      "limit": 1,
      "settings": [
        { "type": "checkbox", "id": "show_label", "label": "Show link label", "default": false },
        { "type": "text", "id": "label_text", "label": "Label text", "default": "See all reviews" },
        { "type": "range", "id": "top_margin", "label": "Top spacing (px)", "min": 0, "max": 48, "step": 4, "default": 12 }
      ]
    },

    { "type": "title", "name": "Right: Product Title", "limit": 1 },
    { "type": "price", "name": "Right: Product Price", "limit": 1 },

    {
      "type": "coming_soon_description",
      "name": "Right: Description",
      "limit": 1,
      "settings": [
        {
          "type": "paragraph",
          "content": "This block controls placement only. Content comes from the 'Product descriptive' metafield (custom.coming_soon_description) on individual product pages."
        }
      ]
    },

    {
      "type": "available_stores",
      "name": "Right: Available Stores",
      "limit": 1,
      "settings": [
        { "type": "text", "id": "title", "label": "Title", "default": "AVAILABLE AT" },
        { "type": "range", "id": "cols", "label": "Columns (desktop)", "min": 2, "max": 6, "step": 1, "default": 3 },
        { "type": "range", "id": "logo_max_size", "label": "Max logo size (px)", "min": 60, "max": 200, "step": 10, "default": 100 },
        { "type": "header", "content": "Mobile settings" },
        { "type": "range", "id": "cols_mobile", "label": "Columns (mobile)", "min": 1, "max": 3, "step": 1, "default": 2 },
        { "type": "range", "id": "logo_max_size_mobile", "label": "Max logo size (px)", "min": 50, "max": 150, "step": 10, "default": 80 }
      ]
    },

    {
      "type": "coming_soon",
      "name": "Right: Coming Soon",
      "limit": 1,
      "settings": [
        { "type": "text", "id": "title", "label": "Title", "default": "COMING SOON" },
        { "type": "text", "id": "email_button_text", "label": "Email button text", "default": "Email me when I can order it!" }
      ]
    },

    { "type": "variant_picker", "name": "Right: Variant Picker", "limit": 1 },

    {
      "type": "quantity_selector",
      "name": "Right: Quantity",
      "limit": 1,
      "settings": [
        { "type": "text", "id": "quantity_label", "label": "Quantity Label", "default": "QUANTITY" }
      ]
    },

    { "type": "buy_buttons", "name": "Right: Buy Buttons", "limit": 1 },

    {
      "type": "wishlist",
      "name": "Right: Wishlist",
      "limit": 1,
      "settings": [
        { "type": "text", "id": "label", "label": "Accessible label", "default": "Add to favorites" },
        { "type": "range", "id": "top_margin", "label": "Top spacing (px)", "min": 0, "max": 40, "step": 4, "default": 12 }
      ]
    }
  ],
  "presets": [
    {
      "name": "product-coffee",
      "blocks": [
        { "type": "gallery" },
        { "type": "details" },
        { "type": "description" },
        { "type": "flavor_profile" },
        { "type": "growing_details" },
        { "type": "brewing_methods" },
        { "type": "reviews" },
        { "type": "recommendations" },
        { "type": "reviews_badge" },
        { "type": "variant_picker" },
        { "type": "quantity_selector" },
        { "type": "buy_buttons" }
      ]
    }
  ]
}
{% endschema %}
