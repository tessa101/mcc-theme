{% comment %}
MCC Product Gallery - Vertical Gallery Variant
Shows all product images in a vertical scrollable layout
Similar to merch desktop gallery pattern
{% endcomment %}

{%- liquid
  assign all_media = product.media
  assign all_images = product.media | where: 'media_type', 'image'
-%}

<style>
/* Force vertical gallery grid layout */
[data-gallery-vertical="{{ section.id }}"] .gallery-vertical-rail,
.layout-coffee [data-gallery-vertical="{{ section.id }}"] .gallery-vertical-rail,
.product-gallery.gallery-vertical .gallery-vertical-rail {
  display: grid !important;
  grid-template-columns: 1fr 1fr !important;
  gap: 2px !important;
  height: auto !important;
  min-height: 0 !important;
  max-height: none !important;
  overflow: visible !important;
  grid-auto-flow: row dense !important;
  list-style: none !important;
  margin: 0 !important;
  padding: 0 !important;
}

[data-gallery-vertical="{{ section.id }}"] .gallery-vertical-item:first-child,
.layout-coffee [data-gallery-vertical="{{ section.id }}"] .gallery-vertical-item:first-child {
  grid-column: 1 / -1 !important;
}

[data-gallery-vertical="{{ section.id }}"] .gallery-vertical-item > *,
.layout-coffee [data-gallery-vertical="{{ section.id }}"] .gallery-vertical-item > * {
  display: block !important;
  width: 100% !important;
  height: auto !important;
}

[data-gallery-vertical="{{ section.id }}"] .gallery-vertical-item,
.layout-coffee [data-gallery-vertical="{{ section.id }}"] .gallery-vertical-item {
  position: relative !important;
  overflow: hidden !important;
}

[data-gallery-vertical="{{ section.id }}"] .gallery-vertical-item:not(:first-child),
.layout-coffee [data-gallery-vertical="{{ section.id }}"] .gallery-vertical-item:not(:first-child) {
  aspect-ratio: 1 / 1 !important;
}

[data-gallery-vertical="{{ section.id }}"] .gallery-vertical-item img,
.layout-coffee [data-gallery-vertical="{{ section.id }}"] .gallery-vertical-item img {
  width: 100% !important;
  height: 100% !important;
  object-fit: cover !important;
  display: block !important;
}

/* Initial hidden state for all items (matching merch desktop exactly) */
[data-gallery-vertical="{{ section.id }}"] .gallery-vertical-item,
.layout-coffee [data-gallery-vertical="{{ section.id }}"] .gallery-vertical-item {
  opacity: 0 !important;
  transform: translateY(40px) !important;
  transition: opacity 0.8s cubic-bezier(0.33, 0.02, 0.1, 1),
              transform 0.8s cubic-bezier(0.33, 0.02, 0.1, 1);
  transition-delay: calc(var(--mcc-stagger, 0) * 80ms);
}

/* Visible state when scrolled into view (matching merch desktop exactly) */
[data-gallery-vertical="{{ section.id }}"] .gallery-vertical-item.is-inview,
.layout-coffee [data-gallery-vertical="{{ section.id }}"] .gallery-vertical-item.is-inview {
  opacity: 1 !important;
  transform: none !important;
  transition-delay: 0.15s !important; /* Ensure delay is applied when visible */
}

/* First item (hero) fades in with delay - no longer immediately visible */
[data-gallery-vertical="{{ section.id }}"] .gallery-vertical-item:first-child,
.layout-coffee [data-gallery-vertical="{{ section.id }}"] .gallery-vertical-item:first-child {
  /* Remove immediate visibility - let animation handle it */
  transition-delay: 0.15s !important; /* Match sidebar delay */
}
</style>

<div class="product-gallery gallery-vertical" data-gallery-vertical="{{ section.id }}">
  {% if all_media.size > 0 %}
    <div class="gallery-vertical-rail" role="list">
      {% for media in all_media %}
        <div 
          class="gallery-vertical-item" 
          role="listitem"
          data-media-id="{{ media.id }}"
          data-media-position="{{ media.position }}"
          {% if forloop.first %}data-is-featured="true"{% endif %}
          style="--mcc-stagger: {{ forloop.index0 }};"
        >
          {% case media.media_type %}
            {% when 'image' %}
              <img
                src="{{ media | image_url: width: 1200 }}"
                srcset="
                  {{ media | image_url: width: 600 }} 600w,
                  {{ media | image_url: width: 900 }} 900w,
                  {{ media | image_url: width: 1200 }} 1200w,
                  {{ media | image_url: width: 1600 }} 1600w
                "
                sizes="(max-width: 749px) 100vw, 50vw"
                alt="{{ media.alt | escape }}"
                width="{{ media.preview_image.width }}"
                height="{{ media.preview_image.height }}"
                loading="{% if forloop.first %}eager{% else %}lazy{% endif %}"
                decoding="async"
                {% if forloop.first %}id="main-product-image"{% endif %}
              />
            {% when 'video' %}
              <div class="gallery-vertical-video">
                {{ media | video_tag: controls: true, playsinline: true, preload: 'metadata' }}
              </div>
            {% when 'external_video' %}
              <div class="gallery-vertical-video">
                {{ media | external_video_tag }}
              </div>
            {% when 'model' %}
              <div class="gallery-vertical-model">
                {{ media | model_viewer_tag: reveal: 'interaction', loading: 'lazy', camera_controls: true }}
              </div>
            {% else %}
              {{ media | media_tag }}
          {% endcase %}
        </div>
      {% endfor %}
    </div>
  {% endif %}
</div>

<script>
/* ===== Coffee Vertical Gallery â€” fade-up on scroll (matching merch desktop) ===== */
(function() {
  function initGallery() {
    const gallery = document.querySelector('[data-gallery-vertical="{{ section.id }}"]');
    if (!gallery) return;
    // Allow re-initialization on reload by checking flag after finding element
    if (gallery.__mccInited) return;
    gallery.__mccInited = true;

    const items = Array.from(gallery.querySelectorAll('.gallery-vertical-item'));
    if (items.length === 0) return;

    // IntersectionObserver for scroll-triggered animations (exact match to merch desktop)
    const io = new IntersectionObserver((entries, obs) => {
      entries.forEach(entry => {
        if (entry.isIntersecting) {
          entry.target.classList.add('is-inview');
          obs.unobserve(entry.target);
        }
      });
    }, { threshold: 0.12 });

    // Set up items: first item gets is-inview with delay, rest are observed
    items.forEach((el, i) => {
      if (i === 0) {
        // First item (hero) - add is-inview with slight delay to match sidebar
        // Use requestAnimationFrame to ensure it happens after CSS is applied
        requestAnimationFrame(function() {
          setTimeout(function() {
            el.classList.add('is-inview');
          }, 150); // Match sidebar delay
        });
      } else {
        // Observe subsequent items for scroll animation
        io.observe(el);
      }
    });
  }

  // Run immediately and on DOM ready - ensure it runs on every load
  function runInit() {
    // Try multiple times to catch the gallery when it's ready
    const gallery = document.querySelector('[data-gallery-vertical="{{ section.id }}"]');
    if (gallery) {
      // Reset flag if it exists to allow re-initialization on reload
      if (gallery.__mccInited) {
        gallery.__mccInited = false;
      }
      initGallery();
      return true;
    } else {
      // Gallery not found yet, try again soon (max 20 attempts = 1 second)
      if (runInit.attempts === undefined) runInit.attempts = 0;
      runInit.attempts++;
      if (runInit.attempts < 20) {
        setTimeout(runInit, 50);
      }
      return false;
    }
  }
  
  // Safety fallback: if gallery still not initialized after 1 second, force show first item
  setTimeout(function() {
    const gallery = document.querySelector('[data-gallery-vertical="{{ section.id }}"]');
    if (gallery) {
      const firstItem = gallery.querySelector('.gallery-vertical-item:first-child');
      if (firstItem && !firstItem.classList.contains('is-inview')) {
        firstItem.classList.add('is-inview');
      }
    }
  }, 1000);
  
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', runInit);
    // Also try immediately in case DOM is ready but event hasn't fired
    setTimeout(runInit, 0);
  } else {
    // DOM already ready, run immediately
    runInit();
  }

  // Also run on section load (Shopify theme editor)
  document.addEventListener('shopify:section:load', function(e) {
    const targetGallery = e.target.querySelector('[data-gallery-vertical="{{ section.id }}"]') || 
                          (e.target.closest && e.target.closest('[data-gallery-vertical="{{ section.id }}"]'));
    if (targetGallery) {
      // Reset initialization flag if section reloaded
      if (targetGallery.__mccInited) {
        targetGallery.__mccInited = false;
      }
      initGallery();
    }
  });
})();
</script>

