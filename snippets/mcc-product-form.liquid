{% comment %}
MCC Product Form Snippet (Dawn-compatible)
- Uses <product-form> + inner <form> (AJAX add-to-cart via Dawn)
- Keeps app blocks inside the form (Recharge selling_plan, etc.)
- Provides safe fallbacks for variant id and quantity
- Includes Dawn's loading spinner stub
{% endcomment %}

{%- comment -%} Detect product type {%- endcomment -%}
{% render 'mcc-product-type-detection', product: product %}

{%- comment -%} Detect coming soon mode - check metafield or tag {%- endcomment -%}
{%- assign is_coming_soon = false -%}
{%- if product.metafields.custom.coming_soon == true -%}
  {%- assign is_coming_soon = true -%}
{%- elsif product.tags contains 'coming-soon' or product.tags contains 'coming_soon' -%}
  {%- assign is_coming_soon = true -%}
{%- endif -%}

{%- comment -%} OOS flag for price/CTA styling {%- endcomment -%}
{%- comment -%} OOS flag (reliable): product.available is false when ALL variants are OOS {%- endcomment -%}
{%- comment -%} All-variants OOS is reliably: product.available == false {%- endcomment -%}

{%- assign all_oos = false -%}
{%- unless product.available -%}{%- assign all_oos = true -%}{%- endunless -%}


<div id="ProductInfo-{{ section.id }}"
     class="product__info-container"
     data-oos="{{ all_oos }}"
     data-section="{{ section.id }}"
     data-product-id="{{ product.id }}"
     data-product-handle="{{ product.handle }}"
     data-url="{{ product.url }}"
     data-update-url="true">


  {%- assign product_form_id = 'product-form-' | append: section.id -%}

  <product-form id="ProductForm-{{ section.id }}" data-section-id="{{ section.id }}">
    <form
      id="{{ product_form_id }}"
      class="product-form"
      method="post"
      action="{{ routes.cart_add_url }}"
      enctype="multipart/form-data"
      novalidate
      data-product-id="{{ product.id }}"
      data-product-handle="{{ product.handle }}"
    >

      {%- comment -%}
      App Blocks & Custom Blocks
      (All inputs must live INSIDE the form to be submitted)
      {%- endcomment -%}
      {%- assign prev_block_type = '' -%}
      {%- for block in section.blocks -%}
        {%- case block.type -%}

          {%- when 'coming_soon_description' -%}
            {%- if is_coming_soon -%}
              {%- comment -%} PRODUCT-LEVEL CONTROL: Content comes from metafield only (custom.coming_soon_description) {%- endcomment -%}
              {%- assign description_text = product.metafields.custom.coming_soon_description -%}
              {%- if description_text != blank -%}
                <div class="block-coming-soon-description description-section" {{ block.shopify_attributes }}>
                  <div class="description-content rte">
                    {{ description_text }}
                  </div>
                </div>
              {%- endif -%}
            {%- endif -%}

          {%- when 'available_stores' -%}
            {%- if is_coming_soon -%}
              {%- comment -%} TEMPLATE-LEVEL CONTROL: Title comes from block settings only (not metafields) {%- endcomment -%}
              {%- assign stores_title = block.settings.title | default: "AVAILABLE AT" -%}
              
              {%- comment -%} PRODUCT-LEVEL CONTROL: Store logos come from metafield list only (custom.coming_soon_stores) {%- endcomment -%}
              {%- assign stores_metafield = product.metafields.custom.coming_soon_stores -%}
              {%- assign stores_from_metafield = stores_metafield.value | default: stores_metafield -%}
              {%- comment -%} Get links from separate metafield - handle both List of URL and comma-separated string {%- endcomment -%}
              {%- assign stores_links_metafield = product.metafields.custom.coming_soon_stores_links -%}
              {%- assign stores_links_raw = stores_links_metafield.value | default: stores_links_metafield -%}
              {%- comment -%} Check if it's a comma-separated string or a list {%- endcomment -%}
              {%- if stores_links_raw contains ',' -%}
                {%- comment -%} It's a comma-separated string - split it and strip whitespace {%- endcomment -%}
                {%- assign stores_links_array = stores_links_raw | split: ',' -%}
                {%- assign stores_links = stores_links_array -%}
              {%- else -%}
                {%- comment -%} It's a list of URL objects or single value - use as is {%- endcomment -%}
                {%- assign stores_links = stores_links_raw -%}
              {%- endif -%}
              {%- assign has_stores = false -%}
              {%- assign stores_count = 0 -%}
              
              {%- if stores_from_metafield != blank and stores_from_metafield.size > 0 -%}
                {%- assign has_stores = true -%}
                {%- assign stores_count = stores_from_metafield.size -%}
              {%- endif -%}
              
              <div class="block-available-stores coming-soon-stores" {{ block.shopify_attributes }}>
                {%- if stores_title != blank -%}
                  <div class="kv-label">{{ stores_title }}</div>
                {%- endif -%}
                {%- if has_stores -%}
                  {%- comment -%} Automatic column calculation: 3 stores = 3 cols, 4 stores = 4 cols (1 row), >5 stores = 3 cols (multiple rows), 1-2 stores = stores_count {%- endcomment -%}
                  {%- if stores_count == 3 -%}
                    {%- assign cols_eff = 3 -%}
                    {%- assign cols_eff_m = 3 -%}
                  {%- elsif stores_count == 4 -%}
                    {%- assign cols_eff = 4 -%}
                    {%- assign cols_eff_m = 2 -%}
                  {%- elsif stores_count > 4 -%}
                    {%- assign cols_eff = 3 -%}
                    {%- assign cols_eff_m = 2 -%}
                  {%- else -%}
                    {%- comment -%} 1-2 stores: use stores_count {%- endcomment -%}
                    {%- assign cols_eff = stores_count -%}
                    {%- assign cols_eff_m = stores_count -%}
                  {%- endif -%}
                  <ul class="ml-grid"
                    style="
                      --cols: {{ cols_eff }};
                      --cols-m: {{ cols_eff_m }};
                      --logo-w: {{ block.settings.logo_max_size | default: 100 }}px;
                      --logo-h: {{ block.settings.logo_max_size | default: 100 }}px;
                      --logo-w-m: {{ block.settings.logo_max_size_mobile | default: 80 }}px;
                      --logo-h-m: {{ block.settings.logo_max_size_mobile | default: 80 }}px;
                      --count: {{ stores_count }};
                      --cols-eff: {{ cols_eff }};
                      --cols-eff-m: {{ cols_eff_m }};
                    ">
                    {%- comment -%} Render stores from metafield list {%- endcomment -%}
                    {%- for store in stores_from_metafield -%}
                      {%- comment -%} Get image from metafield - List item is image directly (Image File type) {%- endcomment -%}
                      {%- assign store_logo = store -%}
                      {%- comment -%} Get link from separate links metafield by matching index {%- endcomment -%}
                      {%- assign store_index = forloop.index0 -%}
                      {%- assign store_link = blank -%}
                      {%- if stores_links != blank -%}
                        {%- if stores_links[store_index] != blank -%}
                          {%- assign link_item = stores_links[store_index] -%}
                          {%- comment -%} Handle both URL objects and plain strings {%- endcomment -%}
                          {%- if link_item.value != blank -%}
                            {%- assign store_link = link_item.value | strip -%}
                          {%- elsif link_item.url != blank -%}
                            {%- assign store_link = link_item.url | strip -%}
                          {%- else -%}
                            {%- assign store_link = link_item | strip -%}
                          {%- endif -%}
                        {%- endif -%}
                      {%- endif -%}
                      
                      <li class="ml-item">
                        {%- if store_link != blank -%}
                          {%- comment -%} Open store links in new tab on desktop and mobile {%- endcomment -%}
                          <a href="{{ store_link }}" class="ml-link" target="_blank" rel="noopener noreferrer">
                        {%- else -%}
                          <div class="ml-link">
                        {%- endif -%}
                          <div class="ml-frame">
                            {%- if store_logo != blank -%}
                              {{ store_logo | image_url: width: 320 | image_tag: class: 'ml-logo', alt: '' | escape }}
                            {%- else -%}
                              <div class="ml-fpo">Logo</div>
                            {%- endif -%}
                          </div>
                        {%- if store_link != blank -%}
                          </a>
                        {%- else -%}
                          </div>
                        {%- endif -%}
                      </li>
                    {%- endfor -%}
                  </ul>
                {%- else -%}
                  <p style="font-size: 14px; color: #666; margin-top: 8px;">Add stores to the <code>custom.coming_soon_stores</code> metafield to display logos.</p>
                {%- endif -%}
              </div>
            {%- endif -%}

          {%- when 'coming_soon' -%}
            {%- if is_coming_soon -%}
              {%- comment -%} TEMPLATE-LEVEL CONTROL: Title and button text come from block settings only (not metafields) {%- endcomment -%}
              {%- assign coming_soon_title = block.settings.title | default: "COMING SOON" -%}
              {%- assign email_button_text = block.settings.email_button_text | default: "Email me when I can order it!" -%}
              
              {%- comment -%} Check if next block is wishlist to combine them {%- endcomment -%}
              {%- assign next_block_is_wishlist = false -%}
              {%- assign next_wishlist_block = null -%}
              {%- if forloop.index < section.blocks.size -%}
                {%- assign next_block = section.blocks[forloop.index] -%}
                {%- if next_block.type == 'wishlist' -%}
                  {%- assign next_block_is_wishlist = true -%}
                  {%- assign next_wishlist_block = next_block -%}
                {%- endif -%}
              {%- endif -%}
              
              <div class="block-coming-soon" {{ block.shopify_attributes }}>
                {%- if coming_soon_title != blank -%}
                  <div class="kv-label">{{ coming_soon_title }}</div>
                {%- endif -%}
                <div class="coming-soon-ctas">
                  <button type="button" class="add-to-cart-full coming-soon-email-cta">
                    {{ email_button_text }}
                  </button>
                  {%- if next_block_is_wishlist -%}
                    {%- comment -%} Render wishlist anchor inside coming-soon-ctas {%- endcomment -%}
                    <div id="mcc-wishlist-anchor"
                         class="wishlist-anchor"
                         aria-label="{{ next_wishlist_block.settings.label | default: 'Add to favorites' }}"
                         style="--wishlist-margin-top: 0px">
                    </div>
                  {%- endif -%}
                </div>
              </div>
            {%- endif -%}

          {%- when '@app' -%}
            <div class="product-app-block{% if is_cold_brew %} product-app-block--hidden{% endif %}" {{ block.shopify_attributes }}>
              <label class="variant-label">PURCHASE OPTIONS</label>
              {% render block %}
            </div>

          {%- when 'variant_picker' -%}
            {% render 'mcc-variant-picker', product: product, block: block, section: section %}

          {%- when 'quantity_selector' -%}
            <div class="block-quantity-selector" {{ block.shopify_attributes }}>
              {% render 'mcc-quantity-selector', block: block, section: section %}
            </div>

          {%- when 'buy_buttons' -%}
            {%- comment -%} Hide buy buttons for cold brew during launch {%- endcomment -%}
            {% unless is_cold_brew %}
              <div class="block-buy-buttons" {{ block.shopify_attributes }}>
                {% render 'mcc-buy-buttons', block: block, section: section, product: product %}
              </div>
            {% endunless %}

          {%- when 'wishlist' -%}
            {%- comment -%} Check if previous block was coming_soon (already rendered inside it) {%- endcomment -%}
            {%- if prev_block_type == 'coming_soon' -%}
              {%- comment -%} Skip rendering - already rendered inside coming-soon {%- endcomment -%}
            {%- else -%}
              <div class="block-wishlist" {{ block.shopify_attributes }}>
                <div id="mcc-wishlist-anchor"
                     class="wishlist-anchor"
                     aria-label="{{ block.settings.label | default: 'Add to favorites' }}"
                     style="--wishlist-margin-top: {{ block.settings.top_margin | default: 12 }}px">
                </div>
              </div>
            {%- endif -%}

          {%- when 'custom_liquid' -%}
            <div class="block-custom-liquid" {{ block.shopify_attributes }}>
              {{ block.settings.custom_liquid }}
            </div>

          {%- when 'text' -%}
            <div class="block-text" {{ block.shopify_attributes }}>
              <p>{{ block.settings.text }}</p>
            </div>

          {%- else -%}
            <div class="hidden-block" {{ block.shopify_attributes }} style="display:none;"></div>
        {%- endcase -%}
        {%- comment -%} Track block type for next iteration {%- endcomment -%}
        {%- assign prev_block_type = block.type -%}
      {%- endfor -%}

      {%- comment -%}
      Fallback content when no blocks are configured (optional)
      {%- endcomment -%}
      {% if section.blocks.size == 0 %}
        {% render 'mcc-variant-picker', product: product, section: section %}

        {%- if product.selling_plan_groups.size > 0 -%}
          <label class="variant-label" aria-hidden="true">PURCHASE OPTIONS</label>
        {%- endif -%}
        <div class="recharge-subscription-container">
          <div class="rc-widget-injection-parent"></div>
        </div>

        {% render 'mcc-quantity-selector', section: section %}
        {% render 'mcc-buy-buttons', product: product, section: section %}
      {% endif %}


      {%- comment -%}
      SAFE FALLBACKS:
      If your variant picker already outputs an element with name="id" (select/radios),
      this fallback gets removed by the tiny script below.
      {%- endcomment -%}
      <input type="hidden"
             name="id"
             value="{{ product.selected_or_first_available_variant.id }}"
             data-fallback-variant-id>

      {%- comment -%}
      If your quantity block outputs an input[name="quantity"], this fallback is removed.
      {%- endcomment -%}
      <input type="hidden" name="quantity" value="1" data-fallback-quantity>

      {%- comment -%}
      Dawn expects a spinner node it toggles on submit; keep it inside the form.
      {%- endcomment -%}
      {% render 'loading-spinner' %}

    </form>
  </product-form>

  {%- comment -%}
  Product JSON for apps (unchanged)
  {%- endcomment -%}
  <script type="application/json" id="mcc-selling-data-{{ section.id }}">
  {
    "productId": {{ product.id }},
    "variants": [
      {% for v in product.variants %}
        {
          "id": {{ v.id }},
          "price": {{ v.price }},
          "compare_at_price": {{ v.compare_at_price | default: 0 }},
          "selling_plan_allocations": [
            {% for spa in v.selling_plan_allocations %}
              {
                "selling_plan_id": {{ spa.selling_plan.id }},
                "title": {{ spa.selling_plan.name | json }},
                "final_price": {{ spa.price }},
                "per_delivery_price": {{ spa.per_delivery_price | default: spa.price }}
              }{% unless forloop.last %},{% endunless %}
            {% endfor %}
          ]
        }{% unless forloop.last %},{% endunless %}
      {% endfor %}
    ]
  }
  </script>

  <script type="application/json" id="ProductJSON-{{ product.id }}">
    {{ product | json }}
  </script>

</div>

{%- comment -%} Hide subscription widget for cold brew by default {%- endcomment -%}
{% if is_cold_brew %}
<style>
  .product-app-block--hidden {
    display: none !important;
  }
</style>
{% endif %}

{%- comment -%}
Tiny helper: remove fallback inputs if real ones exist,
and keep fallbacks synced otherwise. This avoids duplicate `name="id"` or `name="quantity"`.
{%- endcomment -%}
<script>
(function(){
  const wrap = document.getElementById('ProductForm-{{ section.id }}');
  if (!wrap) return;
  const form = wrap.querySelector('form');
  if (!form) return;

  const fallbackId = form.querySelector('[data-fallback-variant-id]');
  const fallbackQty = form.querySelector('[data-fallback-quantity]');

  // If "real" inputs exist, drop fallbacks
  const realId = form.querySelector('input[name="id"]:not([data-fallback-variant-id]), select[name="id"]:not([data-fallback-variant-id])');
  const realQty = form.querySelector('input[name="quantity"]:not([data-fallback-quantity])');

  if (realId && fallbackId) fallbackId.remove();
  if (realQty && fallbackQty) fallbackQty.remove();

  // Keep fallback values in sync if they remain (no real inputs present)
  function syncFallbacks(){
    if (fallbackId && !form.querySelector('input[name="id"]:not([data-fallback-variant-id]), select[name="id"]:not([data-fallback-variant-id])')) {
      const chosen = form.querySelector('input[name="id"]:checked') || form.querySelector('select[name="id"]');
      if (chosen) fallbackId.value = chosen.value;
    }
    if (fallbackQty && !form.querySelector('input[name="quantity"]:not([data-fallback-quantity])')) {
      const qtyInput = form.querySelector('input[name="quantity"]') || document.getElementById('quantity-{{ section.id }}');
      if (qtyInput && qtyInput.value) fallbackQty.value = qtyInput.value;
    }
  }

  document.addEventListener('change', syncFallbacks, true);
  document.addEventListener('input', syncFallbacks, true);
  document.addEventListener('DOMContentLoaded', syncFallbacks);
})();
</script>
