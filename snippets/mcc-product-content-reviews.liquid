{% comment %}
MCC Product Content - Reviews Section Block
{% endcomment %}

<section class="coffee-accordion content-section" data-accordion data-acc="reviews" data-stagger="rows" {{ block.shopify_attributes }}>
  <header class="coffee-acc-header">
    <h2 class="coffee-acc-title coffee-reviews-title">Recent reviews</h2>
    <button class="coffee-acc-trigger" type="button"
            aria-controls="acc-reviews-{{ section.id }}" aria-expanded="true">
      <span class="sr-only">Toggle Recent reviews</span>
    </button>
  </header>
  <div id="acc-reviews-{{ section.id }}" class="coffee-acc-panel mcc-anim" data-acc-panel>
    <div class="pdp-module pdp-reviews" id="reviews" data-mcc-reviews>
      <p class="mcc-reviews-empty-state" style="display: none;">No reviews yet</p>
      <div id="judgeme_product_reviews"
           class="jdgm-widget jdgm-review-widget"
           data-product-title="{{ product.title | escape }}"
           data-id="{{ product.id }}">
        {{ product.metafields.judgeme.widget }}
      </div>
    </div>
  </div>
</section>

<!-- Load the reviews module -->
<script defer src="{{ 'mcc-reviews.js' | asset_url }}"></script>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    window.MCC && MCC.Reviews && MCC.Reviews.init({
      hostSel: '#reviews.pdp-reviews'
    });
  });
</script>

<script>
(function() {
  const host = document.querySelector('#reviews.pdp-reviews');
  if (!host) return;

  const LIST_SEL = '.jdgm-rev-widg__reviews';
  const CARD_SEL = '.jdgm-rev';
  const emptyState = host.querySelector('.mcc-reviews-empty-state');

  function checkReviews() {
    const list = host.querySelector(LIST_SEL);
    const cards = list ? Array.from(list.querySelectorAll(CARD_SEL)) : [];
    const hasReviews = cards.length > 0;

    if (emptyState) {
      emptyState.style.display = hasReviews ? 'none' : 'block';
    }
  }

  function waitForJudgeMe(maxTries = 20) {
    let tries = 0;
    (function tick() {
      checkReviews();
      const list = host.querySelector(LIST_SEL);
      if (list || ++tries >= maxTries) {
        if (list) {
          const mo = new MutationObserver(() => checkReviews());
          mo.observe(list, { childList: true, subtree: true });
        }
        return;
      }
      setTimeout(tick, 300);
    })();
  }

  const widgetObserver = new MutationObserver(() => {
    const widget = host.querySelector('.jdgm-rev-widg');
    if (widget) {
      waitForJudgeMe();
      widgetObserver.disconnect();
    }
  });
  widgetObserver.observe(host, { childList: true, subtree: true });

  waitForJudgeMe();
})();
</script>

